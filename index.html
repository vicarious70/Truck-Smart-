        // NEW
        ownerop: {
          // Editable ‚Äúlists‚Äù for Owner-Op Additions
          householdItems: [
            { id: crypto.randomUUID(), name: "House Payment", amt: 1500 },
            { id: crypto.randomUUID(), name: "Utilities", amt: 500 },
            { id: crypto.randomUUID(), name: "Car Payment", amt: 500 },
            { id: crypto.randomUUID(), name: "Groceries", amt: 700 },
            { id: crypto.randomUUID(), name: "Car Gas", amt: 400 },
            { id: crypto.randomUUID(), name: "Entertainment", amt: 0 }
          ],
          businessItems: [
            { id: crypto.randomUUID(), name: "Truck Payment", amt: 1500 },
            { id: crypto.randomUUID(), name: "Trailer Payment", amt: 1100 },
            { id: crypto.randomUUID(), name: "Insurance", amt: 1500 },
            { id: crypto.randomUUID(), name: "Business Phone", amt: 150 },
            { id: crypto.randomUUID(), name: "Parking", amt: 300 },
            { id: crypto.randomUUID(), name: "ELDs", amt: 25 },
            { id: crypto.randomUUID(), name: "Load Board", amt: 169 }
          ],

          // Reserve % taken from revenue + caps
          reserves: [
            { id: "factoring", name: "Factoring Fee", pct: 3.0, cap: 0, continueAfterCap: true, enabled: true },
            { id: "hwy", name: "Heavy Highway Use Tax", pct: 0.0, cap: 0, continueAfterCap: false, enabled: true },
            { id: "usdot", name: "USDOT Reserve", pct: 0.0, cap: 0, continueAfterCap: false, enabled: true }
          ],

          // ‚ÄúGuide‚Äù dropdown (read-only on dashboard). You can expand this later.
          guides: [
            {
              id: "default",
              name: "Default Blueprint (This Phone)",
              note: "Uses your saved Blueprint + Owner-Op Additions."
            }
          ],

          // Caps progress by year: { "2026": { "factoring": 1200.55, ... } }
          capsByYear: {}
        }
      };

      const blankState = () => ({
        lists: structuredClone(defaults.lists),
        rates: structuredClone(defaults.rates),
        blueprint: structuredClone(defaults.blueprint),
        ownerop: structuredClone(defaults.ownerop),
        trips: [],
        budget: { byMonth: {} }, // { "2026-01": { bufferPct, paychecks, withholdPct, otherIncome, items:[...] } }
        goals: { bizMonthly: 0, personalMonthly: 0 }
      });

      function loadState(){
        const raw = localStorage.getItem(LS_KEY);
        if(!raw) return blankState();
        try{
          const parsed = JSON.parse(raw);
          // Soft-merge with defaults so new fields don‚Äôt explode old saves
          const st = blankState();
          const merged = Object.assign(st, parsed || {});
          merged.lists = Object.assign(st.lists, parsed?.lists || {});
          merged.rates = Object.assign(st.rates, parsed?.rates || {});
          merged.blueprint = Object.assign(st.blueprint, parsed?.blueprint || {});
          merged.ownerop = Object.assign(st.ownerop, parsed?.ownerop || {});
          merged.ownerop.capsByYear = Object.assign(st.ownerop.capsByYear, parsed?.ownerop?.capsByYear || {});
          // Ensure arrays exist
          merged.trips = Array.isArray(parsed?.trips) ? parsed.trips : [];
          merged.budget = parsed?.budget?.byMonth ? parsed.budget : { byMonth: {} };
          merged.goals = Object.assign(st.goals, parsed?.goals || {});
          return merged;
        }catch(e){
          console.warn("State parse failed, resetting", e);
          return blankState();
        }
      }

      function saveState(){
        localStorage.setItem(LS_KEY, JSON.stringify(state));
      }

      let state = loadState();

      // ---------- DOM helpers ----------
      const $ = (id)=> document.getElementById(id);
      const toast = (msg="Saved.")=>{
        const t = $("toast");
        if(!t) return;
        t.textContent = msg;
        t.classList.remove("hide");
        setTimeout(()=> t.classList.add("hide"), 1400);
      };

      const safeVal = (el)=> (el && typeof el.value === "string") ? el.value.trim() : "";
      const numVal = (el)=> {
        const v = parseFloat(safeVal(el));
        return isFinite(v) ? v : 0;
      };

      const todayISO = ()=> new Date().toISOString().slice(0,10);

      function fillSelect(selectEl, arr){
        if(!selectEl) return;
        selectEl.innerHTML = "";
        (arr||[]).forEach((x)=>{
          const opt = document.createElement("option");
          opt.value = x;
          opt.textContent = x;
          selectEl.appendChild(opt);
        });
      }

      function fillDatalist(dlEl, arr){
        if(!dlEl) return;
        dlEl.innerHTML = "";
        (arr||[]).filter((x)=> x && x !== "Select‚Ä¶").forEach((x)=>{
          const opt = document.createElement("option");
          opt.value = x;
          dlEl.appendChild(opt);
        });
      }

      function ensureListItem(listName, value){
        const v = (value||"").trim();
        if(!v || v.toLowerCase() === "select‚Ä¶") return;
        const arr = state.lists[listName] || [];
        if(!arr.includes(v)){
          arr.push(v);
          state.lists[listName] = arr;
          saveState();
        }
      }

      // ---------- Tabs ----------
      function setTab(name){
        document.querySelectorAll(".tab").forEach(t=>{
          t.classList.toggle("active", t.dataset.tab === name);
        });
        document.querySelectorAll("main section[id^='tab-']").forEach(sec=>{
          sec.classList.toggle("hide", sec.id !== "tab-" + name);
        });
        if(name === "invoices") refreshInvoiceTripDropdown();
        if(name === "dashboard") refreshDashboardYearDropdown();
        if(name === "settings") loadSettingsUI();
      }

      document.querySelectorAll(".tab").forEach(t=>{
        t.addEventListener("click", ()=> setTab(t.dataset.tab));
      });

      // ---------- Populate dropdowns ----------
      function refreshDropdowns(){
        fillSelect($("t_company"), state.lists.companies);
        fillSelect($("t_shipper"), state.lists.shippers);
        fillSelect($("t_pickup"), state.lists.locations);
        fillSelect($("t_delivery"), state.lists.locations);
        fillSelect($("t_tire"), state.lists.tires);
        fillSelect($("t_truck"), state.lists.trucks);
        fillSelect($("t_trailer"), state.lists.trailers);
        fillSelect($("t_customer"), state.lists.customers);
        fillSelect($("t_consignee"), state.lists.consignees);

        fillDatalist($("dl_shippers"), state.lists.shippers);
        fillDatalist($("dl_consignees"), state.lists.consignees);

        fillSelect($("b_cat"), ["Select‚Ä¶", ...(state.lists.budgetCats||[]).filter(x=>x!=="Select‚Ä¶")]);

        // Quote box dropdowns
        fillSelect($("q_broker"), state.lists.customers);
        fillSelect($("q_pickup"), state.lists.locations);
        fillSelect($("q_delivery"), state.lists.locations);

        // Blueprint guide
        const guideSel = $("bp_guide");
        if(guideSel){
          guideSel.innerHTML = "";
          (state.ownerop.guides||[]).forEach(g=>{
            const opt = document.createElement("option");
            opt.value = g.id;
            opt.textContent = g.name;
            guideSel.appendChild(opt);
          });
        }
      }

      // ---------- Core calculations ----------
      function calcFuelCost(gal, cpg){
        const g = money(gal);
        const p = money(cpg) || money(state.rates.defaultFuelCPG);
        return g * p;
      }

      function calcMPG(totalMiles, fuelGal){
        const m = money(totalMiles);
        const g = money(fuelGal);
        if(g > 0) return m / g;
        return money(state.rates.targetMPG) || 0;
      }

      function getCapsYear(){
        const ySel = $("bp_caps_year");
        const y = ySel ? safeVal(ySel) : "";
        return y || String(new Date().getFullYear());
      }

      function ensureCapsYear(yearStr){
        if(!state.ownerop.capsByYear[yearStr]) state.ownerop.capsByYear[yearStr] = {};
        return state.ownerop.capsByYear[yearStr];
      }

      function reserveWithCap(yearStr, reserveId, desiredAmt, cap, continueAfterCap){
        const y = ensureCapsYear(yearStr);
        const funded = money(y[reserveId] || 0);
        const capN = money(cap);
        const want = money(desiredAmt);

        if(capN <= 0){
          // no cap
          y[reserveId] = funded + want;
          return want;
        }

        if(funded >= capN){
          if(continueAfterCap){
            y[reserveId] = funded + want;
            return want;
          }
          return 0;
        }

        const remaining = capN - funded;
        const applied = Math.min(remaining, want);
        y[reserveId] = funded + applied;
        return applied;
      }

      function autoReservesForTrip(trip){
        const miles = money(trip.totalMiles);
        const rev = money(trip.revenue);

        // per-mile reserves
        const tires = miles * money(state.rates.tiresPerMile);
        const maint = miles * money(state.rates.maintPerMile);
        const plates = miles * money(state.rates.platesPerMile);
        const ifta = miles * money(state.rates.iftaPerMile);

        // tax is % of revenue
        const tax = rev * (money(state.rates.taxPctRevenue) / 100);

        // % reserves + caps (yearly)
        const yearStr = String((trip.date||"").slice(0,4) || new Date().getFullYear());
        let pctRes = {};
        (state.ownerop.reserves||[]).forEach(r=>{
          if(!r.enabled) return;
          const desired = rev * (money(r.pct) / 100);
          const applied = reserveWithCap(yearStr, r.id, desired, r.cap, !!r.continueAfterCap);
          pctRes[r.id] = applied;
        });

        return { tires, maint, plates, ifta, tax, pctRes };
      }

      function computeTripNumbers(){
        const loaded = numVal($("t_loaded_miles"));
        const dead = numVal($("t_deadhead_miles"));
        const totalMiles = loaded + dead;

        const fuelGal = numVal($("t_fuel_gal"));
        const fuelCPG = numVal($("t_fuel_cpg")) || money(state.rates.defaultFuelCPG);

        const fuelCost = calcFuelCost(fuelGal, fuelCPG);
        $("t_fuel_cost").value = fuelCost ? fuelCost.toFixed(2) : "";

        const mpg = calcMPG(totalMiles, fuelGal);

        const revenue = numVal($("t_revenue"));
        const tolls = numVal($("t_tolls"));
        const other = numVal($("t_other"));

        const hoursRoad = numVal($("t_hours_road")) || money(state.rates.defaultHoursRoad);

        // Reserves: allow manual overrides if user typed something
        const tempTrip = { date: safeVal($("t_date")) || todayISO(), totalMiles, revenue };
        const auto = autoReservesForTrip(tempTrip);

        const tiresR = safeVal($("t_res_tires")) ? numVal($("t_res_tires")) : auto.tires;
        const maintR = safeVal($("t_res_maint")) ? numVal($("t_res_maint")) : auto.maint;
        const platesR = safeVal($("t_res_plates")) ? numVal($("t_res_plates")) : auto.plates;
        const iftaR = safeVal($("t_res_ifta")) ? numVal($("t_res_ifta")) : auto.ifta;
        const taxR = safeVal($("t_res_tax")) ? numVal($("t_res_tax")) : auto.tax;

        // Extra reserve boxes map to reserve ids, but still allow manual override
        const factoringAuto = auto.pctRes["factoring"] || 0;
        const hwyAuto = auto.pctRes["hwy"] || 0;
        const usdotAuto = auto.pctRes["usdot"] || 0;

        const factoringR = safeVal($("t_res_factoring")) ? numVal($("t_res_factoring")) : factoringAuto;
        const hwyR = safeVal($("t_res_hwy")) ? numVal($("t_res_hwy")) : hwyAuto;
        const usdotR = safeVal($("t_res_usdot")) ? numVal($("t_res_usdot")) : usdotAuto;

        // total expenses
        const totalExpenses =
          fuelCost + tolls + other +
          tiresR + maintR + platesR + iftaR + taxR +
          factoringR + hwyR + usdotR;

        const net = revenue - totalExpenses;
        const otraff = hoursRoad > 0 ? (net / hoursRoad) : 0;

        // KPIs
        $("k_total_miles").textContent = fmtNum(totalMiles);
        $("k_fuel_cost").textContent = fmtMoney(fuelCost);
        $("k_mpg").textContent = (isFinite(mpg) ? mpg : 0).toFixed(2);
        $("k_net").textContent = fmtMoney(net);
        $("k_otraff").textContent = fmtMoney(otraff);

        // Write autos into fields if they‚Äôre blank
        if(!safeVal($("t_res_tires"))) $("t_res_tires").value = tiresR ? tiresR.toFixed(2) : "";
        if(!safeVal($("t_res_maint"))) $("t_res_maint").value = maintR ? maintR.toFixed(2) : "";
        if(!safeVal($("t_res_plates"))) $("t_res_plates").value = platesR ? platesR.toFixed(2) : "";
        if(!safeVal($("t_res_ifta"))) $("t_res_ifta").value = iftaR ? iftaR.toFixed(2) : "";
        if(!safeVal($("t_res_tax"))) $("t_res_tax").value = taxR ? taxR.toFixed(2) : "";

        if(!safeVal($("t_res_factoring"))) $("t_res_factoring").value = factoringR ? factoringR.toFixed(2) : "";
        if(!safeVal($("t_res_hwy"))) $("t_res_hwy").value = hwyR ? hwyR.toFixed(2) : "";
        if(!safeVal($("t_res_usdot"))) $("t_res_usdot").value = usdotR ? usdotR.toFixed(2) : "";

        return {
          totalMiles, fuelCost, mpg, net, otraff,
          reserves: { tiresR, maintR, platesR, iftaR, taxR, factoringR, hwyR, usdotR },
          hoursRoad
        };
      }

      // ---------- Trips ----------
      function clearTripForm(){
        $("t_date").value = todayISO();
        ["t_company","t_truck","t_trailer","t_tire","t_shipper","t_pickup","t_delivery","t_customer","t_consignee"].forEach(id=>{
          const el = $(id);
          if(el) el.selectedIndex = 0;
        });
        ["t_shipper_auto","t_consignee_auto","t_ref","t_hours_road","t_pickup_addr","t_delivery_addr",
         "t_loaded_miles","t_deadhead_miles","t_revenue","t_fuel_gal","t_fuel_cpg","t_fuel_cost",
         "t_tolls","t_other","t_notes",
         "t_res_tires","t_res_maint","t_res_plates","t_res_ifta","t_res_tax","t_res_factoring","t_res_hwy","t_res_usdot"
        ].forEach(id=> { const el = $(id); if(el) el.value=""; });

        $("k_total_miles").textContent = "0";
        $("k_fuel_cost").textContent = "$0.00";
        $("k_mpg").textContent = "0.00";
        $("k_net").textContent = "$0.00";
        $("k_otraff").textContent = "$0.00";
      }

      function saveTrip(){
        // Save typed shipper/consignee into lists if present
        ensureListItem("shippers", safeVal($("t_shipper_auto")));
        ensureListItem("consignees", safeVal($("t_consignee_auto")));

        // If user typed shipper/consignee, use it
        const shipperTyped = safeVal($("t_shipper_auto"));
        const consigneeTyped = safeVal($("t_consignee_auto"));

        const nums = computeTripNumbers();

        const trip = {
          id: crypto.randomUUID(),
          date: safeVal($("t_date")) || todayISO(),
          company: safeVal($("t_company")),
          truck: safeVal($("t_truck")),
          trailer: safeVal($("t_trailer")),
          tire: safeVal($("t_tire")),
          shipper: shipperTyped || safeVal($("t_shipper")),
          ref: safeVal($("t_ref")),
          hoursRoad: nums.hoursRoad,
          pickup: safeVal($("t_pickup")),
          delivery: safeVal($("t_delivery")),
          pickupAddr: safeVal($("t_pickup_addr")),
          deliveryAddr: safeVal($("t_delivery_addr")),
          customer: safeVal($("t_customer")),
          consignee: consigneeTyped || safeVal($("t_consignee")),
          calendar: safeVal($("t_calendar")),

          loadedMiles: numVal($("t_loaded_miles")),
          deadheadMiles: numVal($("t_deadhead_miles")),
          totalMiles: nums.totalMiles,
          revenue: numVal($("t_revenue")),

          fuelGal: numVal($("t_fuel_gal")),
          fuelCPG: numVal($("t_fuel_cpg")) || money(state.rates.defaultFuelCPG),
          fuelCost: nums.fuelCost,

          tolls: numVal($("t_tolls")),
          other: numVal($("t_other")),
          notes: safeVal($("t_notes")),

          reserves: structuredClone(nums.reserves),
          net: nums.net,
          otraff: nums.otraff
        };

        state.trips.unshift(trip);
        saveState();
        toast("Trip saved ‚úÖ");
        renderTrips();
        refreshInvoiceTripDropdown();
      }

      function renderTrips(){
        const list = $("tripList");
        if(!list) return;
        const q = safeVal($("searchTrips")).toLowerCase();

        const filtered = state.trips.filter(t=>{
          if(!q) return true;
          const hay = [
            t.date, t.company, t.shipper, t.pickup, t.delivery, t.ref, t.notes, t.customer, t.consignee
          ].join(" ").toLowerCase();
          return hay.includes(q);
        });

        list.innerHTML = "";
        if(filtered.length === 0){
          const div = document.createElement("div");
          div.className = "small";
          div.textContent = "No trips found.";
          list.appendChild(div);
          return;
        }

        filtered.forEach(trip=>{
          const item = document.createElement("div");
          item.className = "item";

          const top = document.createElement("div");
          top.className = "itemTop";

          const left = document.createElement("div");
          const title = document.createElement("div");
          title.className = "itemTitle";
          title.innerHTML = `<b>${trip.pickup || "?"}</b> ‚Üí <b>${trip.delivery || "?"}</b> <span class="small">(${trip.date})</span>`;
          const meta = document.createElement("div");
          meta.className = "itemMeta";
          meta.textContent = `${trip.company || ""} ‚Ä¢ ${trip.shipper || ""} ‚Ä¢ ${trip.ref ? ("Ref: " + trip.ref) : "No ref"}`;
          left.appendChild(title);
          left.appendChild(meta);

          const right = document.createElement("div");
          right.className = "btnRow";
          right.style.marginTop = "0";
          const btnDel = document.createElement("button");
          btnDel.className = "bad";
          btnDel.type = "button";
          btnDel.textContent = "üóëÔ∏è Delete";
          btnDel.addEventListener("click", ()=>{
            if(!confirm("Delete this trip?")) return;
            state.trips = state.trips.filter(x=> x.id !== trip.id);
            saveState();
            renderTrips();
            refreshInvoiceTripDropdown();
            toast("Deleted.");
          });

          right.appendChild(btnDel);

          top.appendChild(left);
          top.appendChild(right);

          const nums = document.createElement("div");
          nums.className = "itemNums mono";
          nums.innerHTML = `
            <div>Miles: <b>${fmtNum(trip.totalMiles)}</b></div>
            <div>Rev: <b>${fmtMoney(trip.revenue)}</b></div>
            <div>Fuel: <b>${fmtMoney(trip.fuelCost)}</b></div>
            <div>Net: <b>${fmtMoney(trip.net)}</b></div>
          `;

          item.appendChild(top);
          item.appendChild(nums);
          list.appendChild(item);
        });
      }

      // ---------- Export / Import ----------
      function exportData(){
        const blob = new Blob([JSON.stringify(state, null, 2)], { type: "application/json" });
        const url = URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url;
        a.download = "trucking-made-simple-backup.json";
        a.click();
        URL.revokeObjectURL(url);
        toast("Exported üì¶");
      }

      function importData(file){
        const reader = new FileReader();
        reader.onload = ()=>{
          try{
            const parsed = JSON.parse(reader.result);
            // Merge into blankState so you don‚Äôt import missing fields and break everything
            const st = blankState();
            state = Object.assign(st, parsed || {});
            state.lists = Object.assign(st.lists, parsed?.lists || {});
            state.rates = Object.assign(st.rates, parsed?.rates || {});
            state.blueprint = Object.assign(st.blueprint, parsed?.blueprint || {});
            state.ownerop = Object.assign(st.ownerop, parsed?.ownerop || {});
            state.ownerop.capsByYear = Object.assign(st.ownerop.capsByYear, parsed?.ownerop?.capsByYear || {});
            if(!Array.isArray(state.trips)) state.trips = [];
            if(!state.budget?.byMonth) state.budget = { byMonth: {} };
            saveState();
            refreshDropdowns();
            renderTrips();
            refreshInvoiceTripDropdown();
            toast("Imported ‚úÖ");
          }catch(e){
            console.error(e);
            alert("Import failed. File isn‚Äôt valid JSON backup.");
          }
        };
        reader.readAsText(file);
      }

      // ---------- Budget ----------
      function getBudgetMonthKey(){
        return safeVal($("b_month")) || new Date().toISOString().slice(0,7);
      }

      function ensureBudgetMonth(key){
        if(!state.budget.byMonth[key]){
          state.budget.byMonth[key] = {
            bufferPct: 15,
            paychecks: 2,
            withholdPct: 20,
            otherIncome: 0,
            items: []
          };
        }
        return state.budget.byMonth[key];
      }

      function renderBudget(){
        const key = getBudgetMonthKey();
        const m = ensureBudgetMonth(key);

        // sync inputs
        $("b_buffer").value = m.bufferPct ?? 15;
        $("b_paychecks").value = String(m.paychecks ?? 2);
        $("b_withhold").value = m.withholdPct ?? 20;
        $("b_other_income").value = m.otherIncome ?? 0;

        const list = $("budgetList");
        list.innerHTML = "";

        const total = (m.items||[]).reduce((a,x)=> a + money(x.amt), 0);
        const buffer = total * (money(m.bufferPct)/100);
        const totalBuffered = total + buffer;

        $("k_b_total").textContent = fmtMoney(totalBuffered);

        // Default display until calc is pressed
        $("k_b_gross").textContent = fmtMoney(0);
        $("k_b_percheck").textContent = fmtMoney(0);
        $("k_b_net").textContent = fmtMoney(0);

        if((m.items||[]).length === 0){
          const s = document.createElement("div");
          s.className = "small";
          s.textContent = "No expenses yet for this month.";
          list.appendChild(s);
          return;
        }

        (m.items||[]).forEach(it=>{
          const row = document.createElement("div");
          row.className = "item";
          row.innerHTML = `
            <div class="itemTop">
              <div>
                <div class="itemTitle"><b>${it.cat}</b> <span class="small">${it.note ? "‚Ä¢ " + it.note : ""}</span></div>
                <div class="itemMeta mono">${key}</div>
              </div>
              <div class="mono"><b>${fmtMoney(it.amt)}</b></div>
            </div>
          `;

          const btns = document.createElement("div");
          btns.className = "btnRow";
          const del = document.createElement("button");
          del.className = "bad";
          del.type = "button";
          del.textContent = "üóëÔ∏è Remove";
          del.addEventListener("click", ()=>{
            m.items = (m.items||[]).filter(x=> x.id !== it.id);
            saveState();
            renderBudget();
            toast("Removed.");
          });
          btns.appendChild(del);
          row.appendChild(btns);

          list.appendChild(row);
        });
      }

      function addBudgetExpense(){
        const key = getBudgetMonthKey();
        const m = ensureBudgetMonth(key);

        m.bufferPct = numVal($("b_buffer")) || 0;
        m.paychecks = parseInt(safeVal($("b_paychecks")) || "2", 10);
        m.withholdPct = numVal($("b_withhold")) || 0;
        m.otherIncome = numVal($("b_other_income")) || 0;

        const cat = safeVal($("b_cat"));
        const amt = numVal($("b_amt"));
        const note = safeVal($("b_note"));
        if(!cat || cat === "Select‚Ä¶" || amt <= 0){
          toast("Pick category + amount.");
          return;
        }

        m.items.unshift({ id: crypto.randomUUID(), cat, amt, note });
        saveState();
        $("b_amt").value = "";
        $("b_note").value = "";
        renderBudget();
        toast("Added ‚ûï");
      }

      function budgetCalc(){
        const key = getBudgetMonthKey();
        const m = ensureBudgetMonth(key);

        m.bufferPct = numVal($("b_buffer")) || 0;
        m.paychecks = parseInt(safeVal($("b_paychecks")) || "2", 10);
        m.withholdPct = numVal($("b_withhold")) || 0;
        m.otherIncome = numVal($("b_other_income")) || 0;

        const total = (m.items||[]).reduce((a,x)=> a + money(x.amt), 0);
        const buffer = total * (money(m.bufferPct)/100);
        const totalBuffered = total + buffer;

        const neededNet = Math.max(0, totalBuffered - money(m.otherIncome));
        const withhold = money(m.withholdPct)/100;
        const neededGross = withhold < 1 ? (neededNet / (1 - withhold)) : neededNet;

        const perCheck = m.paychecks > 0 ? (neededGross / m.paychecks) : neededGross;

        $("k_b_total").textContent = fmtMoney(totalBuffered);
        $("k_b_gross").textContent = fmtMoney(neededGross);
        $("k_b_percheck").textContent = fmtMoney(perCheck);
        $("k_b_net").textContent = fmtMoney(neededNet);

        saveState();
      }

      function clearBudgetMonth(){
        const key = getBudgetMonthKey();
        if(!confirm(`Clear all expenses for ${key}?`)) return;
        state.budget.byMonth[key] = {
          bufferPct: 15,
          paychecks: 2,
          withholdPct: 20,
          otherIncome: 0,
          items: []
        };
        saveState();
        renderBudget();
        toast("Cleared.");
      }

      // ---------- Goals ----------
      function loadGoalsUI(){
        const g = state.goals || { bizMonthly:0, personalMonthly:0 };
        $("g_biz").value = g.bizMonthly || 0;
        $("g_personal").value = g.personalMonthly || 0;
      }

      function saveGoals(){
        state.goals = {
          bizMonthly: numVal($("g_biz")),
          personalMonthly: numVal($("g_personal"))
        };
        saveState();
        const msg = $("goalMsg");
        if(msg) msg.textContent = "Saved ‚úÖ";
        toast("Goals saved");
      }

      // ---------- Dashboard ----------
      function refreshDashboardYearDropdown(){
        const sel = $("d_year");
        if(!sel) return;
        const years = new Set(state.trips.map(t=> (t.date||"").slice(0,4)).filter(Boolean));
        years.add(String(new Date().getFullYear()));
        const arr = Array.from(years).sort().reverse();
        sel.innerHTML = "";
        arr.forEach(y=>{
          const opt = document.createElement("option");
          opt.value = y;
          opt.textContent = y;
          sel.appendChild(opt);
        });
      }

      function computeFixedMonthlyCosts(){
        // From editable Owner-Op additions lists + blueprint driver toggle
        const hh = (state.ownerop.householdItems||[]).reduce((a,x)=> a + money(x.amt), 0);
        const bizBase = (state.ownerop.businessItems||[]).reduce((a,x)=> a + money(x.amt), 0);

        // Also include Blueprint driver wage if enabled (weekly -> monthly approx)
        const driverOn = !!state.blueprint?.business?.driverOn;
        const driverWeek = money(state.blueprint?.business?.driverWeek);
        const driverMonthly = driverOn ? (driverWeek * 4) : 0;

        return { hh, biz: bizBase + driverMonthly, driverMonthly };
      }

      function refreshBlueprintCard(){
        const fixed = computeFixedMonthlyCosts();
        const monthMiles = money(state.blueprint?.miles?.month) || 0;
        const yearMiles = money(state.blueprint?.miles?.year) || 0;
        const hoursPerLoad = money(state.blueprint?.miles?.hoursPerLoad) || 0;

        const fixedTotal = fixed.hh + fixed.biz;

        // Required revenue: fixed + rough reserve and tax padding? Keep it simple: fixed only.
        const required = fixedTotal;

        const otrRPM = monthMiles > 0 ? (required / monthMiles) : 0;
        const localRPM = 6000 > 0 ? (required / 6000) : 0;

        // Hourly wage while away: use fixed monthly / (loads * hours/load) rough
        // loads per month approx = monthMiles / 2500 (placeholder). This isn‚Äôt physics, it‚Äôs budgeting.
        const loads = monthMiles > 0 ? (monthMiles / 2500) : 0;
        const hours = loads * (hoursPerLoad || 10);
        const hourly = hours > 0 ? (required / hours) : 0;

        $("bp_fixed").textContent = fmtMoney(fixedTotal);
        $("bp_required").textContent = fmtMoney(required);
        $("bp_otr_rpm").textContent = fmtMoney(otrRPM);
        $("bp_local_rpm").textContent = fmtMoney(localRPM);
        $("bp_hourly").textContent = fmtMoney(hourly);

        // caps year dropdown
        const capSel = $("bp_caps_year");
        if(capSel){
          const years = new Set(Object.keys(state.ownerop.capsByYear||{}));
          years.add(String(new Date().getFullYear()));
          const arr = Array.from(years).sort().reverse();
          capSel.innerHTML = "";
          arr.forEach(y=>{
            const opt = document.createElement("option");
            opt.value = y;
            opt.textContent = y;
            capSel.appendChild(opt);
          });
          capSel.value = getCapsYear();
        }

        refreshCapsBox();
      }

      function refreshCapsBox(){
        const yearStr = getCapsYear();
        const y = ensureCapsYear(yearStr);
        const box = $("bp_caps_box");
        if(!box) return;

        const rows = (state.ownerop.reserves||[]).map(r=>{
          const funded = money(y[r.id] || 0);
          const cap = money(r.cap);
          if(cap > 0){
            const pct = Math.min(100, (funded / cap) * 100);
            return `‚Ä¢ ${r.name}: ${fmtMoney(funded)} / ${fmtMoney(cap)} (${pct.toFixed(0)}%)`;
          }
          return `‚Ä¢ ${r.name}: ${fmtMoney(funded)} (no cap)`;
        });

        box.innerHTML = `<b>Caps Progress (${yearStr})</b><br>${rows.join("<br>")}`;
      }

      function resetCapsYear(){
        const yearStr = getCapsYear();
        if(!confirm(`Reset reserve caps progress for ${yearStr}?`)) return;
        state.ownerop.capsByYear[yearStr] = {};
        saveState();
        refreshCapsBox();
        toast("Caps reset ‚ôªÔ∏è");
      }

      function dashRefresh(){
        const year = safeVal($("d_year")) || String(new Date().getFullYear());
        const monthFilter = safeVal($("d_month")); // "YYYY-MM" or ""

        const trips = state.trips.filter(t=>{
          const y = (t.date||"").slice(0,4);
          if(y !== year) return false;
          if(monthFilter){
            return (t.date||"").slice(0,7) === monthFilter;
          }
          return true;
        });

        const revenue = trips.reduce((a,t)=> a + money(t.revenue), 0);
        const expenses = trips.reduce((a,t)=> {
          const r = t.reserves || {};
          const resTotal = money(r.tiresR)+money(r.maintR)+money(r.platesR)+money(r.iftaR)+money(r.taxR)+money(r.factoringR)+money(r.hwyR)+money(r.usdotR);
          return a + money(t.fuelCost) + money(t.tolls) + money(t.other) + resTotal;
        }, 0);
        const net = revenue - expenses;
        const miles = trips.reduce((a,t)=> a + money(t.totalMiles), 0);

        $("d_rev").textContent = fmtMoney(revenue);
        $("d_exp").textContent = fmtMoney(expenses);
        $("d_net").textContent = fmtMoney(net);
        $("d_miles").textContent = fmtNum(miles);

        // Insights
        const ins = $("insights");
        ins.innerHTML = "";
        const avgRPM = miles > 0 ? (revenue / miles) : 0;
        const avgNetRPM = miles > 0 ? (net / miles) : 0;

        const cards = [
          { t:"Avg Revenue / Mile", v: fmtMoney(avgRPM) },
          { t:"Avg Net / Mile", v: fmtMoney(avgNetRPM) },
          { t:"Trips Count", v: String(trips.length) }
        ];

        cards.forEach(c=>{
          const d = document.createElement("div");
          d.className = "item";
          d.innerHTML = `<div class="itemTitle"><b>${c.t}</b></div><div class="itemMeta mono">${c.v}</div>`;
          ins.appendChild(d);
        });

        // Goals compare (bizMonthly vs revenue for selected month if filter, else compare to avg per month-ish)
        const gBox = $("dashGoalBox");
        const gOk = $("dashGoalOk");
        if(gBox) gBox.classList.add("hide");
        if(gOk) gOk.classList.add("hide");

        const goal = money(state.goals?.bizMonthly);
        if(goal > 0){
          let basis = revenue;
          let label = monthFilter ? monthFilter : year + " (filtered)";
          if(!monthFilter){
            // crude estimate: compare YTD revenue vs goal * months covered
            const monthsCovered = new Set(trips.map(t=> (t.date||"").slice(0,7))).size || 1;
            const target = goal * monthsCovered;
            if(revenue < target){
              gBox.classList.remove("hide");
              gBox.innerHTML = `<b>Goal gap</b><br>${label}: ${fmtMoney(revenue)} vs target ${fmtMoney(target)} (${monthsCovered} mo).`;
            }else{
              gOk.classList.remove("hide");
              gOk.innerHTML = `<b>Goal on track</b><br>${label}: ${fmtMoney(revenue)} vs target ${fmtMoney(target)}.`;
            }
          }else{
            if(basis < goal){
              gBox.classList.remove("hide");
              gBox.innerHTML = `<b>Goal gap</b><br>${monthFilter}: ${fmtMoney(basis)} vs goal ${fmtMoney(goal)}.`;
            }else{
              gOk.classList.remove("hide");
              gOk.innerHTML = `<b>Goal hit</b><br>${monthFilter}: ${fmtMoney(basis)} vs goal ${fmtMoney(goal)}.`;
            }
          }
        }

        refreshBlueprintCard();
      }

      // ---------- Invoices ----------
      function refreshInvoiceTripDropdown(){
        const sel = $("inv_trip");
        if(!sel) return;
        sel.innerHTML = "";
        const opt0 = document.createElement("option");
        opt0.value = "";
        opt0.textContent = "Select‚Ä¶";
        sel.appendChild(opt0);

        state.trips.forEach(t=>{
          const opt = document.createElement("option");
          opt.value = t.id;
          opt.textContent = `${t.date} ‚Ä¢ ${t.pickup || "?"} ‚Üí ${t.delivery || "?"} ‚Ä¢ ${fmtMoney(t.revenue)}`;
          sel.appendChild(opt);
        });
      }

      function autoInvoiceNumber(trip){
        const d = (trip.date||"").replaceAll("-","");
        const idx = Math.max(1, state.trips.findIndex(x=>x.id===trip.id)+1);
        return `INV-${d}-${String(idx).padStart(3,"0")}`;
      }

      function buildInvoiceHTML(trip){
        const invDate = safeVal($("inv_date")) || todayISO();
        const invNum = safeVal($("inv_number")) || autoInvoiceNumber(trip);

        const subtotal = money(trip.revenue);
        const total = subtotal;

        const pickupLine = trip.pickupAddr ? trip.pickupAddr : (trip.pickup||"");
        const deliveryLine = trip.deliveryAddr ? trip.deliveryAddr : (trip.delivery||"");

        return `
          <div class="invTop">
            <div>
              <div class="invH">INVOICE</div>
              <div class="invMuted">Invoice #: <b>${invNum}</b><br>Date: <b>${invDate}</b></div>
            </div>
            <div class="invMuted" style="text-align:right">
              <b>${trip.company || "Your Company"}</b><br>
              Truck: ${trip.truck || "‚Äî"} ‚Ä¢ Trailer: ${trip.trailer || "‚Äî"}<br>
              Reference: ${trip.ref || "‚Äî"}
            </div>
          </div>

          <div class="invGrid2">
            <div class="invBlock">
              <div class="invMuted"><b>Bill To</b></div>
              <div style="margin-top:6px"><b>${trip.customer || "Broker / Customer"}</b></div>
              <div class="invMuted" style="margin-top:6px">Consignee: ${trip.consignee || "‚Äî"}</div>
            </div>
            <div class="invBlock">
              <div class="invMuted"><b>Shipment Details</b></div>
              <div class="invMuted" style="margin-top:6px">
                Shipper: ${trip.shipper || "‚Äî"}<br>
                Pickup: ${pickupLine || "‚Äî"}<br>
                Delivery: ${deliveryLine || "‚Äî"}<br>
                Miles: ${fmtNum(trip.totalMiles)}
              </div>
            </div>
          </div>

          <table class="invTable">
            <thead>
              <tr>
                <th>Description</th>
                <th class="invRight">Amount</th>
              </tr>
            </thead>
            <tbody>
              <tr>
                <td>Freight Charges (${trip.pickup || "?"} ‚Üí ${trip.delivery || "?"})</td>
                <td class="invRight">${fmtMoney(subtotal)}</td>
              </tr>
            </tbody>
          </table>

          <div class="invTotal">
            <div class="invTotalBox">
              <div class="invLine"><span>Subtotal</span><span>${fmtMoney(subtotal)}</span></div>
              <div class="invLine invBig"><span>Total Due</span><span>${fmtMoney(total)}</span></div>
            </div>
          </div>

          <div class="invMuted" style="margin-top:10px">
            Notes: ${trip.notes ? trip.notes.replaceAll("<","&lt;") : "‚Äî"}
          </div>
        `;
      }

      function invoicePreview(){
        const id = safeVal($("inv_trip"));
        const box = $("invoicePreview");
        if(!id){
          box.innerHTML = `<div class="invMuted">No invoice selected yet.</div>`;
          return;
        }
        const trip = state.trips.find(t=>t.id===id);
        if(!trip){
          box.innerHTML = `<div class="invMuted">Trip not found.</div>`;
          return;
        }
        box.innerHTML = buildInvoiceHTML(trip);
      }

      function invoicePrint(){
        invoicePreview();
        window.print();
      }

      // ---------- Quote Builder ----------
      function quoteRecalcRPM(){
        const miles = numVal($("q_miles"));
        const rate = numVal($("q_rate"));
        const rpm = miles > 0 ? (rate / miles) : 0;
        $("q_rpm").value = rpm ? rpm.toFixed(3) : "";
      }

      function buildQuote(){
        const broker = safeVal($("q_broker"));
        const email = safeVal($("q_email"));
        const pu = safeVal($("q_pickup"));
        const del = safeVal($("q_delivery"));
        const miles = numVal($("q_miles"));
        const rate = numVal($("q_rate"));
        const rpm = miles > 0 ? (rate / miles) : 0;
        const notes = safeVal($("q_notes"));

        $("q_rpm").value = rpm ? rpm.toFixed(3) : "";

        const text =
`Subject: Rate Quote ${pu || "Pickup"} ‚Üí ${del || "Delivery"}

Hi ${broker && broker !== "Select‚Ä¶" ? broker : "there"},

I can cover:
‚Ä¢ Lane: ${pu || "‚Äî"} ‚Üí ${del || "‚Äî"}
‚Ä¢ Total miles: ${miles ? fmtNum(miles) : "‚Äî"}
‚Ä¢ All-in rate: ${rate ? fmtMoney(rate) : "‚Äî"} (${rpm ? rpm.toFixed(3) : "0.000"}/mi)

${notes ? ("Notes: " + notes) : ""}

Thank you,`;

        $("q_out").value = text;
        toast("Quote built ‚úâÔ∏è");
      }

      function copyQuote(){
        const txt = $("q_out").value || "";
        if(!txt){ toast("Nothing to copy."); return; }
        navigator.clipboard.writeText(txt).then(()=> toast("Copied üìã")).catch(()=> {
          $("q_out").select();
          document.execCommand("copy");
          toast("Copied (fallback) üìã");
        });
      }

      function emailQuote(){
        const to = encodeURIComponent(safeVal($("q_email")));
        const body = encodeURIComponent($("q_out").value || "");
        const subjectLine = ($("q_out").value || "").split("\n")[0].replace("Subject:","").trim();
        const subject = encodeURIComponent(subjectLine || "Rate Quote");
        const href = `mailto:${to}?subject=${subject}&body=${body}`;
        window.location.href = href;
      }

      // ---------- Settings: Lists + Rates + Blueprint ----------
      function loadSettingsUI(){
        // lists textareas
        $("s_companies").value = (state.lists.companies||[]).filter(x=>x!=="Select‚Ä¶").join("\n");
        $("s_shippers").value = (state.lists.shippers||[]).filter(x=>x!=="Select‚Ä¶").join("\n");
        $("s_locations").value = (state.lists.locations||[]).filter(x=>x!=="Select‚Ä¶").join("\n");
        $("s_tires").value = (state.lists.tires||[]).filter(x=>x!=="Select‚Ä¶").join("\n");
        $("s_trucks").value = (state.lists.trucks||[]).filter(x=>x!=="Select‚Ä¶").join("\n");
        $("s_trailers").value = (state.lists.trailers||[]).filter(x=>x!=="Select‚Ä¶").join("\n");
        $("s_customers").value = (state.lists.customers||[]).filter(x=>x!=="Select‚Ä¶").join("\n");
        $("s_consignees").value = (state.lists.consignees||[]).filter(x=>x!=="Select‚Ä¶").join("\n");
        $("s_budget_cats").value = (state.lists.budgetCats||[]).filter(x=>x!=="Select‚Ä¶").join("\n");

        // rates
        $("r_tires").value = state.rates.tiresPerMile;
        $("r_maint").value = state.rates.maintPerMile;
        $("r_plates").value = state.rates.platesPerMile;
        $("r_ifta").value = state.rates.iftaPerMile;
        $("r_tax_pct").value = state.rates.taxPctRevenue;
        $("r_mpg").value = state.rates.targetMPG;
        $("r_fuel_cpg").value = state.rates.defaultFuelCPG;
        $("r_hours_road").value = state.rates.defaultHoursRoad;

        // blueprint
        const bp = state.blueprint;
        $("hh_house").value = bp.household.house;
        $("hh_utils").value = bp.household.utils;
        $("hh_car").value = bp.household.car;
        $("hh_food").value = bp.household.food;
        $("hh_gas").value = bp.household.gas;
        $("hh_ent").value = bp.household.ent ?? 0;

        $("biz_truck").value = bp.business.truck;
        $("biz_trailer").value = bp.business.trailer;
        $("biz_ins").value = bp.business.ins;
        $("biz_phone").value = bp.business.phone;
        $("biz_parking").value = bp.business.parking;
        $("biz_eld").value = bp.business.eld;
        $("biz_loadboard").value = bp.business.loadboard;
        $("biz_driver_week").value = bp.business.driverWeek ?? 0;
        $("biz_driver_on").value = (bp.business.driverOn ? "on" : "off");

        $("bp_month_miles").value = bp.miles.month;
        $("bp_year_miles").value = bp.miles.year;
        $("bp_days").value = bp.miles.daysAway;
        $("bp_hours").value = bp.miles.hoursPerLoad;

        // ownerop additions lists
        renderOwnerOpLists();
        refreshBlueprintCard();
      }

      function parseLines(str){
        return (str||"")
          .split("\n")
          .map(s=> s.trim())
          .filter(Boolean);
      }

      function saveLists(){
        state.lists.companies = ["Select‚Ä¶", ...parseLines($("s_companies").value)];
        state.lists.shippers  = ["Select‚Ä¶", ...parseLines($("s_shippers").value)];
        state.lists.locations = ["Select‚Ä¶", ...parseLines($("s_locations").value)];
        state.lists.tires     = ["Select‚Ä¶", ...parseLines($("s_tires").value)];
        state.lists.trucks    = ["Select‚Ä¶", ...parseLines($("s_trucks").value)];
        state.lists.trailers  = ["Select‚Ä¶", ...parseLines($("s_trailers").value)];
        state.lists.customers = ["Select‚Ä¶", ...parseLines($("s_customers").value)];
        state.lists.consignees= ["Select‚Ä¶", ...parseLines($("s_consignees").value)];
        state.lists.budgetCats= parseLines($("s_budget_cats").value);

        saveState();
        refreshDropdowns();
        toast("Lists saved ‚úÖ");
      }

      function resetLists(){
        if(!confirm("Reset dropdown lists to defaults?")) return;
        state.lists = structuredClone(defaults.lists);
        saveState();
        refreshDropdowns();
        loadSettingsUI();
        toast("Reset.");
      }

      function saveRates(){
        state.rates = {
          tiresPerMile: numVal($("r_tires")),
          maintPerMile: numVal($("r_maint")),
          platesPerMile: numVal($("r_plates")),
          iftaPerMile: numVal($("r_ifta")),
          taxPctRevenue: numVal($("r_tax_pct")),
          targetMPG: numVal($("r_mpg")),
          defaultFuelCPG: numVal($("r_fuel_cpg")),
          defaultHoursRoad: numVal($("r_hours_road"))
        };
        saveState();
        toast("Rates saved ‚úÖ");
      }

      function saveBlueprint(){
        state.blueprint = {
          household: {
            house: numVal($("hh_house")),
            utils: numVal($("hh_utils")),
            car: numVal($("hh_car")),
            food: numVal($("hh_food")),
            gas: numVal($("hh_gas")),
            ent: numVal($("hh_ent"))
          },
          business: {
            truck: numVal($("biz_truck")),
            trailer: numVal($("biz_trailer")),
            ins: numVal($("biz_ins")),
            phone: numVal($("biz_phone")),
            parking: numVal($("biz_parking")),
            eld: numVal($("biz_eld")),
            loadboard: numVal($("biz_loadboard")),
            driverWeek: numVal($("biz_driver_week")),
            driverOn: safeVal($("biz_driver_on")) === "on"
          },
          miles: {
            month: numVal($("bp_month_miles")),
            year: numVal($("bp_year_miles")),
            daysAway: numVal($("bp_days")),
            hoursPerLoad: numVal($("bp_hours"))
          }
        };
        saveState();
        refreshBlueprintCard();
        toast("Blueprint saved ‚úÖ");
      }

      // ---------- Owner-Op Additions UI ----------
      function miniItemRow(item, onChange, onDelete){
        const row = document.createElement("div");
        row.className = "miniRow";

        const left = document.createElement("div");
        left.innerHTML = `<div class="name"><b>${item.name}</b></div><div class="tag">Monthly</div>`;

        const amt = document.createElement("input");
        amt.type = "number";
        amt.min = "0";
        amt.step = "0.01";
        amt.value = money(item.amt);
        amt.addEventListener("input", ()=>{
          item.amt = numVal(amt);
          onChange();
        });

        const right = document.createElement("div");
        right.className = "right";
        const rename = document.createElement("input");
        rename.type = "text";
        rename.value = item.name;
        rename.placeholder = "Name";
        rename.addEventListener("input", ()=>{
          item.name = safeVal(rename) || item.name;
          left.querySelector(".name").innerHTML = `<b>${item.name}</b>`;
          onChange();
        });

        const del = document.createElement("button");
        del.type = "button";
        del.className = "bad";
        del.textContent = "üóëÔ∏è";
        del.addEventListener("click", onDelete);

        right.appendChild(rename);
        right.appendChild(del);

        row.appendChild(left);
        row.appendChild(amt);
        row.appendChild(right);
        return row;
      }

      function reserveRow(res, onChange, onDelete){
        const row = document.createElement("div");
        row.className = "resRow";

        const nm = document.createElement("div");
        nm.innerHTML = `<div class="nm"><b>${res.name}</b></div><div class="cap">Revenue % + yearly cap</div>`;

        const pct = document.createElement("input");
        pct.type = "number"; pct.min="0"; pct.step="0.1";
        pct.value = money(res.pct);
        pct.title = "Percent of revenue";
        pct.addEventListener("input", ()=>{ res.pct = numVal(pct); onChange(); });

        const cap = document.createElement("input");
        cap.type = "number"; cap.min="0"; cap.step="0.01";
        cap.value = money(res.cap);
        cap.title = "Yearly cap (0 = no cap)";
        cap.addEventListener("input", ()=>{ res.cap = numVal(cap); onChange(); });

        const cont = document.createElement("select");
        cont.innerHTML = `
          <option value="stop">Stop after cap</option>
          <option value="keep">Continue after cap</option>
        `;
        cont.value = res.continueAfterCap ? "keep" : "stop";
        cont.addEventListener("change", ()=>{ res.continueAfterCap = cont.value === "keep"; onChange(); });

        const tog = document.createElement("div");
        tog.className = "tog";

        const en = document.createElement("button");
        en.type = "button";
        en.className = res.enabled ? "good" : "warn";
        en.textContent = res.enabled ? "Enabled" : "Disabled";
        en.addEventListener("click", ()=>{
          res.enabled = !res.enabled;
          en.className = res.enabled ? "good" : "warn";
          en.textContent = res.enabled ? "Enabled" : "Disabled";
          onChange();
        });

        const del = document.createElement("button");
        del.type = "button";
        del.className = "bad";
        del.textContent = "üóëÔ∏è";
        del.addEventListener("click", onDelete);

        tog.appendChild(en);
        tog.appendChild(del);

        row.appendChild(nm);
        row.appendChild(pct);
        row.appendChild(cap);
        row.appendChild(cont);
        row.appendChild(tog);
        return row;
      }

      function renderOwnerOpLists(){
        // Household list
        const hhWrap = $("hh_list");
        hhWrap.innerHTML = "";
        (state.ownerop.householdItems||[]).forEach(it=>{
          hhWrap.appendChild(
            miniItemRow(it,
              ()=>{ saveState(); refreshBlueprintCard(); },
              ()=>{
                state.ownerop.householdItems = state.ownerop.householdItems.filter(x=>x.id!==it.id);
                saveState(); renderOwnerOpLists(); refreshBlueprintCard();
              }
            )
          );
        });

        // Business list
        const bizWrap = $("biz_list");
        bizWrap.innerHTML = "";
        (state.ownerop.businessItems||[]).forEach(it=>{
          bizWrap.appendChild(
            miniItemRow(it,
              ()=>{ saveState(); refreshBlueprintCard(); },
              ()=>{
                state.ownerop.businessItems = state.ownerop.businessItems.filter(x=>x.id!==it.id);
                saveState(); renderOwnerOpLists(); refreshBlueprintCard();
              }
            )
          );
        });

        // Reserves list
        const resWrap = $("res_list");
        resWrap.innerHTML = "";
        (state.ownerop.reserves||[]).forEach(r=>{
          resWrap.appendChild(
            reserveRow(r,
              ()=>{ saveState(); refreshCapsBox(); },
              ()=>{
                if(!confirm(`Delete reserve "${r.name}"?`)) return;
                state.ownerop.reserves = state.ownerop.reserves.filter(x=>x.id!==r.id);
                saveState();
                renderOwnerOpLists();
                refreshCapsBox();
              }
            )
          );
        });
      }

      function addHHItem(){
        state.ownerop.householdItems.push({ id: crypto.randomUUID(), name: "New Household Expense", amt: 0 });
        saveState();
        renderOwnerOpLists();
        toast("Added.");
      }

      function addBizItem(){
        state.ownerop.businessItems.push({ id: crypto.randomUUID(), name: "New Business Expense", amt: 0 });
        saveState();
        renderOwnerOpLists();
        toast("Added.");
      }

      function resetReserveDefaults(){
        if(!confirm("Reset reserve % + caps to defaults?")) return;
        state.ownerop.reserves = structuredClone(defaults.ownerop.reserves);
        saveState();
        renderOwnerOpLists();
        refreshCapsBox();
        toast("Reset.");
      }

      function saveOwnerOpAdditions(){
        // everything is already live-edited; this just commits + celebrates
        saveState();
        refreshBlueprintCard();
        toast("Owner-Op additions saved ‚úÖ");
      }

      // ---------- Nuke ----------
      function nukeAll(){
        if(!confirm("Delete ALL data? This cannot be undone.")) return;
        if(!confirm("Seriously. This wipes trips, budget, goals. Proceed?")) return;
        localStorage.removeItem(LS_KEY);
        state = blankState();
        saveState();
        refreshDropdowns();
        clearTripForm();
        renderTrips();
        renderBudget();
        loadGoalsUI();
        refreshInvoiceTripDropdown();
        refreshDashboardYearDropdown();
        refreshBlueprintCard();
        toast("All data deleted üß®");
      }

      // ---------- Wire up events ----------
      // default dates
      if($("t_date")) $("t_date").value = todayISO();
      if($("t_calendar")) $("t_calendar").value = todayISO();
      if($("b_month")) $("b_month").value = new Date().toISOString().slice(0,7);

      refreshDropdowns();
      renderTrips();
      renderBudget();
      loadGoalsUI();
      refreshInvoiceTripDropdown();
      refreshDashboardYearDropdown();
      refreshBlueprintCard();

      $("btn_calc").addEventListener("click", ()=> { computeTripNumbers(); toast("Calculated üßÆ"); });
      $("btn_save").addEventListener("click", saveTrip);
      $("btn_clear").addEventListener("click", ()=> { clearTripForm(); toast("Cleared."); });

      $("searchTrips").addEventListener("input", renderTrips);

      $("btn_export").addEventListener("click", exportData);
      $("btn_import").addEventListener("click", ()=> $("importFile").click());
      $("importFile").addEventListener("change", (e)=>{
        const f = e.target.files?.[0];
        if(f) importData(f);
        e.target.value = "";
      });

      // Auto fuel cost calc on input
      ["t_fuel_gal","t_fuel_cpg","t_loaded_miles","t_deadhead_miles","t_revenue","t_tolls","t_other","t_hours_road"].forEach(id=>{
        const el = $(id);
        if(el) el.addEventListener("input", ()=> computeTripNumbers());
      });

      // Budget
      $("b_month").addEventListener("change", renderBudget);
      $("btn_add_exp").addEventListener("click", addBudgetExpense);
      $("btn_budget_calc").addEventListener("click", budgetCalc);
      $("btn_budget_clear").addEventListener("click", clearBudgetMonth);

      // Goals
      $("btn_save_goals").addEventListener("click", saveGoals);

      // Dashboard
      $("btn_dash").addEventListener("click", dashRefresh);
      $("d_year").addEventListener("change", dashRefresh);
      $("d_month").addEventListener("change", dashRefresh);

      // Blueprint card controls
      $("btn_jump_settings").addEventListener("click", ()=> setTab("settings"));
      $("bp_caps_year").addEventListener("change", refreshCapsBox);
      $("btn_reset_caps_year").addEventListener("click", resetCapsYear);

      // Invoices
      $("btn_inv_preview").addEventListener("click", invoicePreview);
      $("btn_inv_print").addEventListener("click", invoicePrint);

      // Quote builder
      $("q_miles").addEventListener("input", quoteRecalcRPM);
      $("q_rate").addEventListener("input", quoteRecalcRPM);
      $("btn_quote_build").addEventListener("click", buildQuote);
      $("btn_quote_copy").addEventListener("click", copyQuote);
      $("btn_quote_email").addEventListener("click", emailQuote);

      // Settings
      $("btn_save_lists").addEventListener("click", saveLists);
      $("btn_reset_lists").addEventListener("click", resetLists);

      $("btn_save_rates").addEventListener("click", saveRates);
      $("btn_blueprint_save").addEventListener("click", saveBlueprint);

      $("btn_hh_add").addEventListener("click", addHHItem);
      $("btn_biz_add").addEventListener("click", addBizItem);
      $("btn_resets_defaults").addEventListener("click", resetReserveDefaults);
      $("btn_ownerop_save").addEventListener("click", saveOwnerOpAdditions);

      $("btn_save_budget_cats").addEventListener("click", saveLists); // categories are part of lists

      $("btn_nuke").addEventListener("click", nukeAll);

      // Make sure settings reflect saved state when first opened
      // (Not loading immediately avoids a bunch of DOM churn on first paint)
      setStatus("‚úÖ Ready");
      console.log("SCRIPT READY");
    } catch (err) {
      console.error("Init Error:", err);
      setStatus("‚ùå Error (open Console)");
    }
  });
</script>

</body>
</html>

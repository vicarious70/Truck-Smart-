<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Trucking Made Simple</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 16px; }
    header { display:flex; align-items:center; justify-content:space-between; gap:12px; }
    .card { border: 1px solid #ddd; border-radius: 10px; padding: 12px; margin: 12px 0; }
    label { display:block; font-size: 12px; margin-top: 8px; }
    input, textarea { width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 8px; }
    button { padding: 10px 12px; border-radius: 10px; border: 1px solid #888; background: #fff; }
    table { width: 100%; border-collapse: collapse; }
    th, td { text-align:left; padding: 8px; border-bottom: 1px solid #eee; vertical-align: top; }
    .row { display:grid; grid-template-columns: 1fr 1fr; gap: 10px; }
    .muted { color:#666; font-size: 12px; }
    .actions { display:flex; gap:8px; flex-wrap:wrap; }
    .twoCol { display:flex; gap:16px; }
    .twoCol > div { flex:1; }
    .box { border:1px solid #eee; border-radius:10px; padding:10px; }
    @media (max-width: 720px) {
      .twoCol { flex-direction: column; }
    }
    @media print {
      .no-print { display:none !important; }
      body { margin: 0; }
      .card { border: none; }
      .box { border: none; padding: 0; }
    }
  </style>
</head>
<body>
  <header class="no-print">
    <div>
      <h2 style="margin:0;">Trucking Made Simple</h2>
      <div class="muted">Billing + invoices (saved on this device). Export regularly for backup.</div>
    </div>
    <div class="actions">
      <button id="printInvoiceBtn" disabled>Print Invoice</button>
      <button id="exportBtn">Export Data</button>
      <input id="importFile" type="file" accept="application/json" style="display:none;" />
      <button id="importBtn">Import Data</button>
      <button id="clearBtn">Clear (This Device)</button>
    </div>
  </header>

  <div class="card no-print">
    <h3 style="margin-top:0;">Company Settings (prints on invoices)</h3>

    <div class="row">
      <div>
        <label>Company Name</label>
        <input id="bizName" placeholder="Trucking Made Simple LLC" />
      </div>
      <div>
        <label>Phone</label>
        <input id="bizPhone" placeholder="(555) 555-5555" />
      </div>
    </div>

    <div class="row">
      <div>
        <label>Email</label>
        <input id="bizEmail" placeholder="billing@yourcompany.com" />
      </div>
      <div>
        <label>Invoice Terms (example: Net 7)</label>
        <input id="bizTerms" placeholder="Net 7" />
      </div>
    </div>
alert("TEST ALERT");
    <label>Address (prints on invoices)</label>
    <textarea id="bizAddress" rows="3" placeholder="Street&#10;City, State ZIP"></textarea>

    <label>Payment Instructions (prints on invoices)</label>
    <textarea id="bizPay" rows="3" placeholder="Make checks payable to...&#10;ACH: Bank / Routing / Account&#10;Or any instructions you want"></textarea>

    <div style="margin-top:10px;" class="actions">
      <button id="saveBizBtn">Save Company Info</button>
    </div>
    <div class="muted" style="margin-top:6px;">
      Company info saves on THIS device. If you use another device, you’ll enter it again.
    </div>
  </div>
<div class="card no-print" id="calcCard">
  <h3 style="margin-top:0;">Rate & Profit Calculator (Before You Accept)</h3>
  <div class="muted">Shows both Loaded RPM (broker) and All-In RPM (true).</div>

  <div class="twoCol" style="margin-top:10px;">
    <!-- SETTINGS -->
    <div class="box">
      <h4 style="margin:0 0 8px 0;">Owner-Op Settings</h4>

      <div class="row">
        <div>
          <label>MPG</label>
          <input id="calc_mpg" type="number" step="0.1" />
        </div>
        <div>
          <label>Fuel Price ($/gal)</label>
          <input id="calc_fuelPrice" type="number" step="0.01" />
        </div>
      </div>

      <div class="row">
        <div>
          <label>Weekly Fixed Costs ($/week)</label>
          <input id="calc_weeklyFixed" type="number" step="1" />
        </div>
        <div>
          <label>Expected Weekly Miles</label>
          <input id="calc_weeklyMiles" type="number" step="1" />
        </div>
      </div>

      <div class="row">
        <div>
          <label>Maintenance Reserve ($/mi)</label>
          <input id="calc_maintPerMi" type="number" step="0.01" />
        </div>
        <div>
          <label>Other Variable ($/mi)</label>
          <input id="calc_otherVarPerMi" type="number" step="0.01" />
        </div>
      </div>

      <div class="row">
        <div>
          <label>Dispatch Fee (%)</label>
          <input id="calc_dispatchPct" type="number" step="0.1" />
        </div>
        <div>
          <label>Factoring Fee (%)</label>
          <input id="calc_factoringPct" type="number" step="0.1" />
        </div>
      </div>

      <div class="row">
        <div>
          <label>Minimum Profit ($/mi)</label>
          <input id="calc_minProfitPerMi" type="number" step="0.01" />
        </div>
        <div>
          <label>Target Profit ($/mi)</label>
          <input id="calc_targetProfitPerMi" type="number" step="0.01" />
        </div>
      </div>

      <div class="actions" style="margin-top:10px;">
        <button id="calc_saveSettingsBtn" type="button">Save Settings</button>
        <button id="calc_resetDefaultsBtn" type="button">Reset Defaults</button>
      </div>

      <div class="muted" id="calc_quickStats" style="margin-top:8px;"></div>
    </div>

    <!-- EVALUATE LOAD -->
    <div class="box">
      <h4 style="margin:0 0 8px 0;">Evaluate a Load</h4>

      <div class="row">
        <div>
          <label>Offered Rate ($)</label>
          <input id="calc_rate" type="number" step="0.01" placeholder="2500" />
        </div>
        <div>
          <label>Loaded Miles</label>
          <input id="calc_loadedMiles" type="number" step="1" placeholder="1000" />
        </div>
      </div>

      <div class="row">
        <div>
          <label>Deadhead Miles</label>
          <input id="calc_deadheadMiles" type="number" step="1" placeholder="150" />
        </div>
        <div>
          <label>Other Trip Costs ($)</label>
          <input id="calc_tripOther" type="number" step="0.01" placeholder="0" />
        </div>
      </div>

      <div class="row">
        <div>
          <label>Tolls ($)</label>
          <input id="calc_tolls" type="number" step="0.01" placeholder="0" />
        </div>
        <div>
          <label>Lumper ($)</label>
          <input id="calc_lumper" type="number" step="0.01" placeholder="0" />
        </div>
      </div>

      <div class="row">
        <div>
          <label>Scales ($)</label>
          <input id="calc_scales" type="number" step="0.01" placeholder="0" />
        </div>
        <div>
          <label>Fuel Override ($/gal) (optional)</label>
          <input id="calc_fuelOverride" type="number" step="0.01" placeholder="leave blank" />
        </div>
      </div>

      <div class="row">
        <div>
          <label>MPG Override (optional)</label>
          <input id="calc_mpgOverride" type="number" step="0.1" placeholder="leave blank" />
        </div>
        <div>
          <label>Notes (optional)</label>
          <input id="calc_notes" placeholder="Broker, lane, etc." />
        </div>
      </div>

      <div class="actions" style="margin-top:10px;">
        <button id="calc_calculateBtn" type="button">Calculate</button>
        <div id="calc_debug" style="margin-top:8px; font-size:14px; font-weight:600;"></div>
        <button id="calc_saveEvalBtn" type="button">Save Evaluation</button>
      </div>

      <hr style="margin:12px 0;" />

      <h4 style="margin:0 0 6px 0;">Results</h4>
      <div id="calc_verdict" style="font-weight:bold; margin-bottom:8px;"></div>

      <div class="twoCol">
        <div class="box">
          <div><b>Net Profit:</b> <span id="calc_netProfit">$0</span></div>
          <div><b>Net / Total Mile:</b> <span id="calc_netPerMi">$0/mi</span></div>
          <div class="muted"><span id="calc_milesLine"></span></div>
        </div>
        <div class="box">
          <div><b>Loaded RPM (broker):</b> <span id="calc_loadedRpm">$—</span></div>
          <div><b>All-In RPM (true):</b> <span id="calc_allInRpm">$—</span></div>
        </div>
      </div>

      <div class="box" style="margin-top:10px;">
        <div style="font-weight:bold; margin-bottom:6px;">What to Ask For</div>
        <div><b>Minimum Total Rate:</b> <span id="calc_minRate">$—</span></div>
        <div class="muted">Min Loaded RPM: <span id="calc_minLoadedRpm">$—</span> • Min All-In RPM: <span id="calc_minAllInRpm">$—</span></div>
        <div style="margin-top:6px;"><b>Target Total Rate:</b> <span id="calc_targetRate">$—</span></div>
        <div class="muted">Target Loaded RPM: <span id="calc_targetLoadedRpm">$—</span> • Target All-In RPM: <span id="calc_targetAllInRpm">$—</span></div>
        <div style="margin-top:6px;"><b>Ask for:</b> <span id="calc_askMore">$—</span></div>
      </div>

      <details style="margin-top:10px;">
        <summary><b>Breakdown</b></summary>
        <div class="muted" id="calc_breakdown" style="margin-top:8px;"></div>
      </details>

      <hr style="margin:12px 0;" />
      <h4 style="margin:0 0 6px 0;">Saved Evaluations</h4>
      <div class="muted" id="calc_historyEmpty">No evaluations saved yet.</div>
      <div id="calc_history"></div>
    </div>
  </div>
</div>
  <div class="card no-print">
    <h3 style="margin-top:0;">Add Load</h3>

    <div class="row">
      <div>
        <label>Customer (Bill To)</label>
        <input id="customer" placeholder="ABC Logistics" />
     <label>Customer Address (Bill To)</label>
<textarea id="customerAddress" rows="2" placeholder="Street&#10;City, State ZIP"></textarea>

<div style="margin-top:10px;" class="actions">
  <button id="saveCustomerBtn" type="button">Save Customer</button>
</div>
<div class="muted">Tip: Save once, then typing the same customer name will auto-fill the address.</div>
      </div>
      <div>
        <label>Invoice #</label>
        <input id="invoiceNo" placeholder="INV-1001" />
      </div>
    </div>

    <div class="row">
      <div>
        <label>Load / Trip #</label>
        <input id="loadNo" placeholder="L-1001" />
      </div>
      <div>
        <label>Rate ($)</label>
        <input id="rate" type="number" step="0.01" placeholder="2500.00" />
      </div>
    </div>

    <div class="row">
      <div>
        <label>Shipper (Company Name)</label>
        <input id="shipperName" list="shipperList" placeholder="ABC Warehouse" />
<datalist id="shipperList"></datalist>
      </div>
      <div>
        <label>Consignee (Company Name)</label>
        <input id="consigneeName" list="consigneeList" placeholder="XYZ Distribution" />
<datalist id="consigneeList"></datalist>
      </div>
    </div>

    <label>Shipper Address</label>
    <textarea id="shipperAddress" rows="2" placeholder="Street&#10;City, State ZIP"></textarea>
<div style="margin-top:10px;" class="actions">
  <button id="saveShipperBtn" type="button">Save Shipper</button>
</div>
<div class="muted">Tip: Save once. Next time select the shipper name from suggestions to auto-fill address.</div>
    <label>Consignee Address</label>
    <textarea id="consigneeAddress" rows="2" placeholder="Street&#10;City, State ZIP"></textarea>
<div style="margin-top:10px;" class="actions">
  <button id="saveConsigneeBtn" type="button">Save Consignee</button>
</div>
<div class="muted">Tip: Save once. Next time select the consignee name from suggestions to auto-fill address.</div>
    <div class="row">
      <div>
        <label>Pickup (City, ST)</label>
        <input id="pickup" placeholder="Dallas, TX" />
      </div>
      <div>
        <label>Delivery (City, ST)</label>
        <input id="delivery" placeholder="Atlanta, GA" />
      </div>
    </div>

    <div class="row">
      <div>
        <label>Pickup Date</label>
        <input id="pickupDate" type="date" />
      </div>
      <div>
        <label>Delivery Date</label>
        <input id="deliveryDate" type="date" />
      </div>
    </div>

    <label>Notes (prints on invoice)</label>
    <textarea id="notes" rows="3" placeholder="Any notes for this load..."></textarea>

    <div style="margin-top:10px;" class="actions">
      <button id="addBtn">Save Load</button>
    </div>
  </div>

  <div class="card no-print">
    <h3 style="margin-top:0;">Loads</h3>
    <table>
      <thead>
        <tr>
          <th>Invoice</th>
          <th>Customer</th>
          <th>Route</th>
          <th>Rate</th>
          <th></th>
        </tr>
      </thead>
      <tbody id="loadsTbody"></tbody>
    </table>
  </div>

  <div class="card" id="invoiceCard" style="display:none;">
    <h2 style="margin-top:0;">Invoice</h2>
    <div class="muted" id="invMeta"></div>
    <hr />
    <div id="invBody"></div>
    <hr />
    <h3 style="margin:0;">Total Due: <span id="invTotal"></span></h3>
    <div class="muted">Tip: On mobile, use your browser menu → Print → Save as PDF.</div>
  </div>

<script>
window.addEventListener("DOMContentLoaded", () => {
  window.onerror = function (msg, src, line, col, err) {
  alert("JS ERROR: " + msg + " (line " + line + ")");
};

alert("DOM Loaded ✅");
  const KEY = "tms_loads_v1";
  const COMPANY_KEY = "tms_company_v1";
const CUSTOMER_KEY = "tms_customers_v1";
const SHIPPER_KEY = "tms_shippers_v1";
const CONSIGNEE_KEY = "tms_consignees_v1";
const CALC_SETTINGS_KEY = "tms_calc_settings_v1";
const CALC_HISTORY_KEY = "tms_calc_history_v1";

function loadJson(key, fallback) {
  try { return JSON.parse(localStorage.getItem(key) || JSON.stringify(fallback)); }
  catch { return fallback; }
}
function saveJson(key, value) {
  localStorage.setItem(key, JSON.stringify(value));
}const CALC_DEFAULTS = {
  mpg: 6.5,
  fuelPrice: 3.80,
  weeklyFixed: 1800,
  weeklyMiles: 2500,
  maintPerMi: 0.15,
  otherVarPerMi: 0.00,
  dispatchPct: 0,
  factoringPct: 0,
  minProfitPerMi: 0.40,
  targetProfitPerMi: 0.70,
};

let calcSettings = loadJson(CALC_SETTINGS_KEY, CALC_DEFAULTS);
let calcHistory = loadJson(CALC_HISTORY_KEY, []);
let calcLastResult = null;
function loadMap(key) {
  try { return JSON.parse(localStorage.getItem(key) || "{}"); }
  catch { return {}; }
}
function saveMap(key, map) {
  localStorage.setItem(key, JSON.stringify(map));
}

let shippers = loadMap(SHIPPER_KEY);
let consignees = loadMap(CONSIGNEE_KEY);
function loadCustomers() {
  try { return JSON.parse(localStorage.getItem(CUSTOMER_KEY) || "{}"); }
  catch { return {}; }
}
function saveCustomers(map) {
  localStorage.setItem(CUSTOMER_KEY, JSON.stringify(map));
}

let customers = loadCustomers();
  function loadData() {
    try { return JSON.parse(localStorage.getItem(KEY) || "[]"); }
    catch { return []; }
  }
  function saveData(items) {
    localStorage.setItem(KEY, JSON.stringify(items));
  }

  function loadCompany() {
    try { return JSON.parse(localStorage.getItem(COMPANY_KEY) || "{}"); }
    catch { return {}; }
  }
  function saveCompany(c) {
    localStorage.setItem(COMPANY_KEY, JSON.stringify(c));
  }

  function money(n) {
    const x = Number(n || 0);
    return x.toLocaleString(undefined, { style: "currency", currency: "USD" });
  }

  function escapeHtml(s) {
    return String(s || "")
      .replaceAll("&","&amp;")
      .replaceAll("<","&lt;")
      .replaceAll(">","&gt;")
      .replaceAll('"',"&quot;")
      .replaceAll("'","&#039;");
  }

  let loads = loadData();
  let company = loadCompany();
  let selectedId = null;

  const els = {
    function calcDebug(msg) {
  const el = document.getElementById("calc_debug");
  if (el) el.textContent = msg;
}

calcDebug("Calculator script loaded ✅");

const calcBtn = document.getElementById("calc_calculateBtn");
if (!calcBtn) {
  calcDebug("ERROR: Calculate button not found (calc_calculateBtn).");
} else {
  calcDebug("Calculate button found ✅ Tap Calculate.");
  calcBtn.addEventListener("click", () => {
    try {
      calcDebug("Clicked ✅ Calculating...");
      readCalcSettingsFromForm();
      const r = calcCompute();
      calcRender(r);
      calcDebug("Done ✅ Results updated.");
    } catch (e) {
      calcDebug("JS ERROR: " + (e && e.message ? e.message : String(e)));
    }
  });
}
    loadsTbody: document.getElementById("loadsTbody"),
    invoiceCard: document.getElementById("invoiceCard"),
    invMeta: document.getElementById("invMeta"),
    invBody: document.getElementById("invBody"),
    invTotal: document.getElementById("invTotal"),
    printInvoiceBtn: document.getElementById("printInvoiceBtn"),
    exportBtn: document.getElementById("exportBtn"),
    importBtn: document.getElementById("importBtn"),
    importFile: document.getElementById("importFile"),
    clearBtn: document.getElementById("clearBtn"),
    addBtn: document.getElementById("addBtn"),
    saveBizBtn: document.getElementById("saveBizBtn"),
  };
  // --- Calculator helpers ---
function fmtMoney(n) {
  const x = Number(n || 0);
  return x.toLocaleString(undefined, { style: "currency", currency: "USD" });
}
function fmtNum(n, digits = 2) {
  const x = Number(n || 0);
  return x.toFixed(digits);
}

function setCalcFormFromSettings() {
  document.getElementById("calc_mpg").value = calcSettings.mpg;
  document.getElementById("calc_fuelPrice").value = calcSettings.fuelPrice;
  document.getElementById("calc_weeklyFixed").value = calcSettings.weeklyFixed;
  document.getElementById("calc_weeklyMiles").value = calcSettings.weeklyMiles;
  document.getElementById("calc_maintPerMi").value = calcSettings.maintPerMi;
  document.getElementById("calc_otherVarPerMi").value = calcSettings.otherVarPerMi;
  document.getElementById("calc_dispatchPct").value = calcSettings.dispatchPct;
  document.getElementById("calc_factoringPct").value = calcSettings.factoringPct;
  document.getElementById("calc_minProfitPerMi").value = calcSettings.minProfitPerMi;
  document.getElementById("calc_targetProfitPerMi").value = calcSettings.targetProfitPerMi;

  const fixedPerMi = calcSettings.weeklyMiles
    ? calcSettings.weeklyFixed / calcSettings.weeklyMiles
    : 0;

  document.getElementById("calc_quickStats").textContent =
    `Fixed cost/mi: ${fmtMoney(fixedPerMi)} • Targets: min ${fmtMoney(calcSettings.minProfitPerMi)}/mi, target ${fmtMoney(calcSettings.targetProfitPerMi)}/mi`;
}

function readCalcSettingsFromForm() {
  calcSettings = {
    mpg: Number(document.getElementById("calc_mpg").value || CALC_DEFAULTS.mpg),
    fuelPrice: Number(document.getElementById("calc_fuelPrice").value || CALC_DEFAULTS.fuelPrice),
    weeklyFixed: Number(document.getElementById("calc_weeklyFixed").value || CALC_DEFAULTS.weeklyFixed),
    weeklyMiles: Number(document.getElementById("calc_weeklyMiles").value || CALC_DEFAULTS.weeklyMiles),
    maintPerMi: Number(document.getElementById("calc_maintPerMi").value || CALC_DEFAULTS.maintPerMi),
    otherVarPerMi: Number(document.getElementById("calc_otherVarPerMi").value || CALC_DEFAULTS.otherVarPerMi),
    dispatchPct: Number(document.getElementById("calc_dispatchPct").value || 0),
    factoringPct: Number(document.getElementById("calc_factoringPct").value || 0),
    minProfitPerMi: Number(document.getElementById("calc_minProfitPerMi").value || CALC_DEFAULTS.minProfitPerMi),
    targetProfitPerMi: Number(document.getElementById("calc_targetProfitPerMi").value || CALC_DEFAULTS.targetProfitPerMi),
  };
}

function calcCompute() {
  const rate = Number(document.getElementById("calc_rate").value || 0);
  const LM = Number(document.getElementById("calc_loadedMiles").value || 0);
  const DH = Number(document.getElementById("calc_deadheadMiles").value || 0);
  const TM = LM + DH;

  const tolls = Number(document.getElementById("calc_tolls").value || 0);
  const lumper = Number(document.getElementById("calc_lumper").value || 0);
  const scales = Number(document.getElementById("calc_scales").value || 0);
  const tripOther = Number(document.getElementById("calc_tripOther").value || 0);
  const tripCosts = tolls + lumper + scales + tripOther;

  const fuelOverride = document.getElementById("calc_fuelOverride").value;
  const mpgOverride = document.getElementById("calc_mpgOverride").value;

  const fuelPrice = fuelOverride ? Number(fuelOverride) : calcSettings.fuelPrice;
  const mpg = mpgOverride ? Number(mpgOverride) : calcSettings.mpg;

  const feePct = (calcSettings.dispatchPct + calcSettings.factoringPct) / 100;
  const fees = rate * feePct;

  const gallons = mpg > 0 ? TM / mpg : 0;
  const fuel = gallons * fuelPrice;

  const variable = TM * (calcSettings.maintPerMi + calcSettings.otherVarPerMi);

  const fixedPerMi =
    calcSettings.weeklyMiles > 0
      ? calcSettings.weeklyFixed / calcSettings.weeklyMiles
      : 0;

  const fixedAllocated = TM * fixedPerMi;

  const net = rate - fees - fuel - tripCosts - variable - fixedAllocated;
  const netPerMi = TM > 0 ? net / TM : 0;

  const loadedRpm = LM > 0 ? rate / LM : null;
  const allInRpm = TM > 0 ? rate / TM : null;

  const otherCosts = fuel + tripCosts + variable + fixedAllocated;
  const minGoal = TM * calcSettings.minProfitPerMi;
  const targetGoal = TM * calcSettings.targetProfitPerMi;

  const minRate =
    1 - feePct > 0 ? (minGoal + otherCosts) / (1 - feePct) : null;
  const targetRate =
    1 - feePct > 0 ? (targetGoal + otherCosts) / (1 - feePct) : null;

  const verdict =
    netPerMi >= calcSettings.targetProfitPerMi
      ? "✅ TAKE IT"
      : netPerMi >= calcSettings.minProfitPerMi
      ? "⚠️ BORDERLINE"
      : "❌ PASS";

  return {
    rate, LM, DH, TM,
    fees, fuel, tripCosts, variable, fixedAllocated,
    net, netPerMi,
    loadedRpm, allInRpm,
    minRate, targetRate,
    verdict
  };
}

function calcRender(r) {
  document.getElementById("calc_verdict").textContent = r.verdict;
  document.getElementById("calc_netProfit").textContent = fmtMoney(r.net);
  document.getElementById("calc_netPerMi").textContent = `${fmtMoney(r.netPerMi)}/mi`;
  document.getElementById("calc_milesLine").textContent =
    `Loaded ${r.LM} • Deadhead ${r.DH} • Total ${r.TM}`;

  document.getElementById("calc_loadedRpm").textContent =
    r.loadedRpm == null ? "$—" : `${fmtMoney(r.loadedRpm)}/mi`;
  document.getElementById("calc_allInRpm").textContent =
    r.allInRpm == null ? "$—" : `${fmtMoney(r.allInRpm)}/mi`;

  document.getElementById("calc_minRate").textContent =
    r.minRate == null ? "$—" : fmtMoney(r.minRate);
  document.getElementById("calc_targetRate").textContent =
    r.targetRate == null ? "$—" : fmtMoney(r.targetRate);

  document.getElementById("calc_askMore").textContent =
    r.targetRate ? fmtMoney(r.targetRate - r.rate) : "$—";
}

// --- Calculator button wiring ---
document.getElementById("calc_saveSettingsBtn").addEventListener("click", () => {
  readCalcSettingsFromForm();
  saveJson(CALC_SETTINGS_KEY, calcSettings);
  setCalcFormFromSettings();
  alert("Calculator settings saved.");
});

document.getElementById("calc_resetDefaultsBtn").addEventListener("click", () => {
  calcSettings = { ...CALC_DEFAULTS };
  saveJson(CALC_SETTINGS_KEY, calcSettings);
  setCalcFormFromSettings();
  alert("Defaults restored.");
});
alert("About to wire Calculate ✅");
  const calcBtn = document.getElementById("calc_calculateBtn");
if (!calcBtn) {
  alert("ERROR: calc_calculateBtn not found in HTML");
} else {
  calcBtn.addEventListener("click", () => {
    alert("Calculate clicked!");
    readCalcSettingsFromForm();
    const r = calcCompute();
    calcRender(r);
  });
}
});
});

});
}
function fmtNum(n, digits = 2) {
  const x = Number(n || 0);
  return x.toFixed(digits);
}

function setCalcFormFromSettings() {
  document.getElementById("calc_mpg").value = calcSettings.mpg;
  document.getElementById("calc_fuelPrice").value = calcSettings.fuelPrice;
  document.getElementById("calc_weeklyFixed").value = calcSettings.weeklyFixed;
  document.getElementById("calc_weeklyMiles").value = calcSettings.weeklyMiles;
  document.getElementById("calc_maintPerMi").value = calcSettings.maintPerMi;
  document.getElementById("calc_otherVarPerMi").value = calcSettings.otherVarPerMi;
  document.getElementById("calc_dispatchPct").value = calcSettings.dispatchPct;
  document.getElementById("calc_factoringPct").value = calcSettings.factoringPct;
  document.getElementById("calc_minProfitPerMi").value = calcSettings.minProfitPerMi;
  document.getElementById("calc_targetProfitPerMi").value = calcSettings.targetProfitPerMi;

  const fixedPerMi = calcSettings.weeklyMiles
    ? calcSettings.weeklyFixed / calcSettings.weeklyMiles
    : 0;

  document.getElementById("calc_quickStats").textContent =
    `Fixed cost/mi: ${fmtMoney(fixedPerMi)} • Targets: min ${fmtMoney(calcSettings.minProfitPerMi)}/mi, target ${fmtMoney(calcSettings.targetProfitPerMi)}/mi`;
}

function readCalcSettingsFromForm() {
  calcSettings = {
    mpg: Number(document.getElementById("calc_mpg").value || CALC_DEFAULTS.mpg),
    fuelPrice: Number(document.getElementById("calc_fuelPrice").value || CALC_DEFAULT
};

let calcSettings = loadJson(CALC_SETTINGS_KEY, CALC_DEFAULTS);
let calcHistory = loadJson(CALC_HISTORY_KEY, []);
let calcLastResult = null;
  const customerInput = document.getElementById("customer");
const customerAddressInput = document.getElementById("customerAddress");
const saveCustomerBtn = document.getElementById("saveCustomerBtn");
// --- Shipper / Consignee dropdown + autofill ---
const shipperNameEl = document.getElementById("shipperName");
const shipperAddrEl = document.getElementById("shipperAddress");
const consigneeNameEl = document.getElementById("consigneeName");
const consigneeAddrEl = document.getElementById("consigneeAddress");

const shipperListEl = document.getElementById("shipperList");
const consigneeListEl = document.getElementById("consigneeList");

const saveShipperBtn = document.getElementById("saveShipperBtn");
const saveConsigneeBtn = document.getElementById("saveConsigneeBtn");

function normName(s) {
  return (s || "").trim().toLowerCase();
}

function fillDatalist(listEl, map) {
  if (!listEl) return;
  listEl.innerHTML = "";
  Object.values(map)
    .sort((a,b) => (a.name||"").localeCompare(b.name||""))
    .forEach(item => {
      const opt = document.createElement("option");
      opt.value = item.name;
      listEl.appendChild(opt);
    });
}

function autofillFromMap(nameEl, addrEl, map) {
  const key = normName(nameEl.value);
  if (!key) return;
  const saved = map[key];
  if (saved && !addrEl.value.trim()) {
    addrEl.value = saved.address || "";
  }
}

// Populate dropdowns on load
fillDatalist(shipperListEl, shippers);
fillDatalist(consigneeListEl, consignees);

// Autofill when user selects or leaves field
shipperNameEl.addEventListener("change", () =>
  autofillFromMap(shipperNameEl, shipperAddrEl, shippers)
);
shipperNameEl.addEventListener("blur", () =>
  autofillFromMap(shipperNameEl, shipperAddrEl, shippers)
);

consigneeNameEl.addEventListener("change", () =>
  autofillFromMap(consigneeNameEl, consigneeAddrEl, consignees)
);
consigneeNameEl.addEventListener("blur", () =>
  autofillFromMap(consigneeNameEl, consigneeAddrEl, consignees)
);

// Save buttons
saveShipperBtn.addEventListener("click", () => {
  const name = shipperNameEl.value.trim();
  const address = shipperAddrEl.value.trim();
  if (!name) return alert("Enter a shipper name first.");
  if (!address) return alert("Enter the shipper address to save.");
  shippers[normName(name)] = { name, address };
  saveMap(SHIPPER_KEY, shippers);
  fillDatalist(shipperListEl, shippers);
  alert("Shipper saved. Select it next time to auto-fill.");
});

saveConsigneeBtn.addEventListener("click", () => {
  const name = consigneeNameEl.value.trim();
  const address = consigneeAddrEl.value.trim();
  if (!name) return alert("Enter a consignee name first.");
  if (!address) return alert("Enter the consignee address to save.");
  consignees[normName(name)] = { name, address };
  saveMap(CONSIGNEE_KEY, consignees);
  fillDatalist(consigneeListEl, consignees);
  alert("Consignee saved. Select it next time to auto-fill.");
});
function autofillCustomerAddress() {
  const name = (customerInput.value || "").trim().toLowerCase();
  if (!name) return;
  const saved = customers[name];
  if (saved && !customerAddressInput.value.trim()) {
    customerAddressInput.value = saved.address || "";
  }
}

customerInput.addEventListener("blur", autofillCustomerAddress);
customerInput.addEventListener("change", autofillCustomerAddress);

saveCustomerBtn.addEventListener("click", () => {
  const nameRaw = (customerInput.value || "").trim();
  const address = (customerAddressInput.value || "").trim();
  if (!nameRaw) { alert("Enter a customer name first."); return; }
  if (!address) { alert("Enter the customer address to save."); return; }

  customers[nameRaw.toLowerCase()] = { name: nameRaw, address };
  saveCustomers(customers);
  alert("Customer saved. Next time the address will auto-fill.");
});

  function fillCompanyForm() {
    document.getElementById("bizName").value = company.bizName || "";
    document.getElementById("bizPhone").value = company.bizPhone || "";
    document.getElementById("bizEmail").value = company.bizEmail || "";
    document.getElementById("bizTerms").value = company.bizTerms || "";
    document.getElementById("bizAddress").value = company.bizAddress || "";
    document.getElementById("bizPay").value = company.bizPay || "";
  }

  function renderLoads() {
    els.loadsTbody.innerHTML = "";
    if (!loads.length) {
      const tr = document.createElement("tr");
      tr.innerHTML = `<td colspan="5" class="muted">No loads yet. Add one above.</td>`;
      els.loadsTbody.appendChild(tr);
      return;
    }
    loads.forEach(l => {
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${escapeHtml(l.invoiceNo || "")}</td>
        <td>${escapeHtml(l.customer || "")}</td>
        <td>${escapeHtml(l.pickup || "")} → ${escapeHtml(l.delivery || "")}</td>
        <td>${money(l.rate)}</td>
        <td class="actions">
          <button data-action="view" data-id="${l.id}">View Invoice</button>
          <button data-action="delete" data-id="${l.id}">Delete</button>
        </td>
      `;
      els.loadsTbody.appendChild(tr);
    });
  }

  function showInvoice(id) {
    const l = loads.find(x => x.id === id);
    if (!l) return;
    selectedId = id;

    els.invoiceCard.style.display = "block";
    els.printInvoiceBtn.disabled = false;

    els.invMeta.textContent = `Invoice #${l.invoiceNo || ""} • Load ${l.loadNo || ""}`;

    const companyBlock = `
      <div style="margin-bottom:10px;">
        <div><b>${escapeHtml(company.bizName || "Trucking Made Simple")}</b></div>
        <div>${escapeHtml(company.bizAddress || "").replaceAll("\n","<br/>")}</div>
        <div>${escapeHtml(company.bizPhone || "")}${company.bizPhone && company.bizEmail ? " • " : ""}${escapeHtml(company.bizEmail || "")}</div>
        <div>${company.bizTerms ? "<b>Terms:</b> " + escapeHtml(company.bizTerms) : ""}</div>
      </div>
    `;

    const paymentBlock = company.bizPay
      ? `<p><b>Payment Instructions:</b><br/>${escapeHtml(company.bizPay).replaceAll("\n","<br/>")}</p>`
      : "";

    const shipperName = l.shipperName || "—";
    const shipperAddr = l.shipperAddress || "—";
    const consigneeName = l.consigneeName || "—";
    const consigneeAddr = l.consigneeAddress || "—";

    els.invBody.innerHTML = `
      ${companyBlock}
<p><b>Bill To:</b><br/>
  ${escapeHtml(l.customer || "—")}<br/>
  ${escapeHtml(l.customerAddress || "—").replaceAll("\n","<br/>")}
</p>
      
      <div class="twoCol" style="margin:10px 0;">
        <div class="box">
          <b>Shipper:</b><br/>
          ${escapeHtml(shipperName)}<br/>
          ${escapeHtml(shipperAddr).replaceAll("\n","<br/>")}
        </div>
        <div class="box">
          <b>Consignee:</b><br/>
          ${escapeHtml(consigneeName)}<br/>
          ${escapeHtml(consigneeAddr).replaceAll("\n","<br/>")}
        </div>
      </div>

      <p><b>Route:</b> ${escapeHtml(l.pickup || "")} → ${escapeHtml(l.delivery || "")}</p>

      <p><b>Pickup Date:</b> ${escapeHtml(l.pickupDate || "")}<br/>
         <b>Delivery Date:</b> ${escapeHtml(l.deliveryDate || "")}</p>

      <p><b>Notes:</b><br/>${escapeHtml(l.notes || "").replaceAll("\n","<br/>")}</p>

      ${paymentBlock}
    `;
    els.invTotal.textContent = money(l.rate);
    window.scrollTo({ top: document.body.scrollHeight, behavior: "smooth" });
  }

  // Company Save
  els.saveBizBtn.addEventListener("click", () => {
    company = {
      bizName: document.getElementById("bizName").value.trim(),
      bizPhone: document.getElementById("bizPhone").value.trim(),
      bizEmail: document.getElementById("bizEmail").value.trim(),
      bizTerms: document.getElementById("bizTerms").value.trim(),
      bizAddress: document.getElementById("bizAddress").value.trim(),
      bizPay: document.getElementById("bizPay").value.trim(),
    };
    saveCompany(company);
    alert("Company info saved on this device.");
  });

  // Save Load
  els.addBtn.addEventListener("click", () => {
    const l = {customerAddress: (document.getElementById("customerAddress").value || "").trim(),
      id: crypto.randomUUID ? crypto.randomUUID() : String(Date.now()),
      customer: (document.getElementById("customer").value || "").trim(),
      invoiceNo: (document.getElementById("invoiceNo").value || "").trim(),
      loadNo: (document.getElementById("loadNo").value || "").trim(),
      rate: document.getElementById("rate").value,

      shipperName: (document.getElementById("shipperName").value || "").trim(),
      shipperAddress: (document.getElementById("shipperAddress").value || "").trim(),
      consigneeName: (document.getElementById("consigneeName").value || "").trim(),
      consigneeAddress: (document.getElementById("consigneeAddress").value || "").trim(),

      pickup: (document.getElementById("pickup").value || "").trim(),
      delivery: (document.getElementById("delivery").value || "").trim(),
      pickupDate: document.getElementById("pickupDate").value,
      deliveryDate: document.getElementById("deliveryDate").value,
      notes: (document.getElementById("notes").value || "").trim(),
      createdAt: new Date().toISOString()
    };

    loads.unshift(l);
    saveData(loads);
    renderLoads();

    // Clear form
    document.getElementById("customer").value = "";
    document.getElementById("invoiceNo").value = "";
    document.getElementById("loadNo").value = "";
    document.getElementById("rate").value = "";
    document.getElementById("shipperName").value = "";
    document.getElementById("shipperAddress").value = "";
    document.getElementById("consigneeName").value = "";
    document.getElementById("consigneeAddress").value = "";
    document.getElementById("pickup").value = "";
    document.getElementById("delivery").value = "";
    document.getElementById("pickupDate").value = "";
    document.getElementById("deliveryDate").value = "";
    document.getElementById("notes").value = "";

    alert("Saved.");
  });

  // Table actions
  els.loadsTbody.addEventListener("click", (e) => {
    const btn = e.target.closest("button");
    if (!btn) return;
    const id = btn.getAttribute("data-id");
    const action = btn.getAttribute("data-action");

    if (action === "view") showInvoice(id);

    if (action === "delete") {
      if (!confirm("Delete this load?")) return;
      loads = loads.filter(x => x.id !== id);
      saveData(loads);

      if (selectedId === id) {
        els.invoiceCard.style.display = "none";
        els.printInvoiceBtn.disabled = true;
      }
      renderLoads();
    }
  });

  els.printInvoiceBtn.addEventListener("click", () => {
    if (!selectedId) return;
    window.print();
  });

  // Export / Import / Clear
  els.exportBtn.addEventListener("click", () => {
  const payload = {
    version: 2,
    exportedAt: new Date().toISOString(),
    loads,
    company,
    customers,
    shippers,
    consignees
  };

  const blob = new Blob([JSON.stringify(payload, null, 2)], { type: "application/json" });
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = "trucking-made-simple-backup.json";
  a.click();
  URL.revokeObjectURL(url);
});

  

  els.importBtn.addEventListener("click", () => {
    els.importFile.click();
  });
els.importFile.addEventListener("change", async (e) => {
  const file = e.target.files?.[0];
  if (!file) return;

  const text = await file.text();

  try {
    const parsed = JSON.parse(text);

    // Backward compatible:
    // - Old exports might be an array of loads, or {loads:[...]}
    const incomingLoads = Array.isArray(parsed) ? parsed : (parsed.loads || []);
    if (!Array.isArray(incomingLoads)) throw new Error("Bad loads format");

    loads = incomingLoads;
    saveData(loads);

    // Restore optional sections if present
    if (parsed.company && typeof parsed.company === "object") {
      company = parsed.company;
      saveCompany(company);
      fillCompanyForm();
    }

    if (parsed.customers && typeof parsed.customers === "object") {
      customers = parsed.customers;
      saveCustomers(customers);
    }

    if (parsed.shippers && typeof parsed.shippers === "object") {
      shippers = parsed.shippers;
      saveMap(SHIPPER_KEY, shippers);
      // refresh dropdown list if available
      if (typeof fillDatalist === "function") fillDatalist(document.getElementById("shipperList"), shippers);
    }

    if (parsed.consignees && typeof parsed.consignees === "object") {
      consignees = parsed.consignees;
      saveMap(CONSIGNEE_KEY, consignees);
      // refresh dropdown list if available
      if (typeof fillDatalist === "function") fillDatalist(document.getElementById("consigneeList"), consignees);
    }

    renderLoads();
    setCalcFormFromSettings();
    alert("Imported everything successfully.");
  } catch {
    alert("Import failed. Make sure you selected the exported backup JSON file.");
  } finally {
    e.target.value = "";
  }
});
  

  els.clearBtn.addEventListener("click", () => {
    if (!confirm("Clear all loads on this device?")) return;
    loads = [];
    saveData(loads);
    els.invoiceCard.style.display = "none";
    els.printInvoiceBtn.disabled = true;
    renderLoads();
  });

  // Init
  fillCompanyForm();
  renderLoads();
});
</script>
</body>
</html>

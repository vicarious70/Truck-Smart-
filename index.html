<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Trucking Made Simple</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 16px; }
    header { display:flex; align-items:center; justify-content:space-between; gap:12px; }
    .card { border: 1px solid #ddd; border-radius: 10px; padding: 12px; margin: 12px 0; }
    label { display:block; font-size: 12px; margin-top: 8px; }
    input, textarea { width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 8px; }
    button { padding: 10px 12px; border-radius: 10px; border: 1px solid #888; background: #fff; cursor:pointer; }
    table { width: 100%; border-collapse: collapse; }
    th, td { text-align:left; padding: 8px; border-bottom: 1px solid #eee; vertical-align: top; }
    .row { display:grid; grid-template-columns: 1fr 1fr; gap: 10px; }
    .muted { color:#666; font-size: 12px; }
    .actions { display:flex; gap:8px; flex-wrap:wrap; }
    .twoCol { display:flex; gap:16px; }
    .twoCol > div { flex:1; }
    .box { border:1px solid #eee; border-radius:10px; padding:10px; }
    @media (max-width: 720px) {
      .twoCol { flex-direction: column; }
    }
    @media print {
      .no-print { display:none !important; }
      body { margin: 0; }
      .card { border: none; }
      .box { border: none; padding: 0; }
    }
  </style>
</head>
<body>

<!-- ===== YOUR HTML UI IS UNCHANGED ABOVE THIS POINT ===== -->
<!-- I left your UI exactly as-is for loads, calculator, etc. -->
<!-- (Truncated here for readability in this message) -->
<!-- Keep your existing body content exactly the same -->

<script>
document.addEventListener("DOMContentLoaded", () => {

  const KEY = "tms_loads_v1";
  const COMPANY_KEY = "tms_company_v1";

  function loadJson(key, fallback) {
    try { return JSON.parse(localStorage.getItem(key) || JSON.stringify(fallback)); }
    catch { return fallback; }
  }

  function saveJson(key, value) {
    localStorage.setItem(key, JSON.stringify(value));
  }

  function money(n) {
    return Number(n || 0).toLocaleString(undefined, { style:"currency", currency:"USD" });
  }

  let loads = loadJson(KEY, []);
  let company = loadJson(COMPANY_KEY, {});
  let selectedId = null;

  const els = {
    loadsTbody: document.getElementById("loadsTbody"),
    invoiceCard: document.getElementById("invoiceCard"),
    invMeta: document.getElementById("invMeta"),
    invBody: document.getElementById("invBody"),
    invTotal: document.getElementById("invTotal"),
    printInvoiceBtn: document.getElementById("printInvoiceBtn"),
    exportBtn: document.getElementById("exportBtn"),
    importBtn: document.getElementById("importBtn"),
    importFile: document.getElementById("importFile"),
    clearBtn: document.getElementById("clearBtn"),
    addBtn: document.getElementById("addBtn"),
    saveBizBtn: document.getElementById("saveBizBtn"),
  };

  function renderLoads() {
    els.loadsTbody.innerHTML = "";
    if (!loads.length) {
      els.loadsTbody.innerHTML = `<tr><td colspan="5" class="muted">No loads yet.</td></tr>`;
      return;
    }
    loads.forEach(l => {
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${l.invoiceNo || ""}</td>
        <td>${l.customer || ""}</td>
        <td>${l.pickup || ""} → ${l.delivery || ""}</td>
        <td>${money(l.rate)}</td>
        <td class="actions">
          <button data-action="view" data-id="${l.id}">View Invoice</button>
          <button data-action="delete" data-id="${l.id}">Delete</button>
        </td>
      `;
      els.loadsTbody.appendChild(tr);
    });
  }

  function showInvoice(id) {
    const l = loads.find(x => x.id === id);
    if (!l) return;

    selectedId = id;
    els.invoiceCard.style.display = "block";
    els.printInvoiceBtn.disabled = false;

    els.invMeta.textContent = `Invoice #${l.invoiceNo || ""}`;
    els.invBody.innerHTML = `
      <p><b>Customer:</b> ${l.customer || ""}</p>
      <p><b>Route:</b> ${l.pickup || ""} → ${l.delivery || ""}</p>
      <p><b>Notes:</b><br/>${(l.notes||"").replaceAll("\n","<br/>")}</p>
    `;
    els.invTotal.textContent = money(l.rate);
  }

  // ===== BUTTON WIRING (FIXED) =====

  els.addBtn.addEventListener("click", () => {
    const l = {
      id: crypto.randomUUID ? crypto.randomUUID() : String(Date.now()),
      customer: document.getElementById("customer").value.trim(),
      invoiceNo: document.getElementById("invoiceNo").value.trim(),
      loadNo: document.getElementById("loadNo").value.trim(),
      rate: document.getElementById("rate").value,
      pickup: document.getElementById("pickup").value.trim(),
      delivery: document.getElementById("delivery").value.trim(),
      notes: document.getElementById("notes").value.trim(),
      createdAt: new Date().toISOString()
    };

    loads.unshift(l);
    saveJson(KEY, loads);
    renderLoads();
    alert("Load saved.");
  });

  els.loadsTbody.addEventListener("click", (e) => {
    const btn = e.target.closest("button");
    if (!btn) return;
    const id = btn.dataset.id;
    const action = btn.dataset.action;

    if (action === "view") showInvoice(id);

    if (action === "delete") {
      if (!confirm("Delete this load?")) return;
      loads = loads.filter(x => x.id !== id);
      saveJson(KEY, loads);
      renderLoads();
    }
  });

  els.printInvoiceBtn.addEventListener("click", () => window.print());

  els.exportBtn.addEventListener("click", () => {
    const blob = new Blob([JSON.stringify({ loads, company }, null, 2)], { type:"application/json" });
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = "trucking-backup.json";
    a.click();
    URL.revokeObjectURL(url);
  });

  els.importBtn.addEventListener("click", () => els.importFile.click());

  els.importFile.addEventListener("change", async (e) => {
    const file = e.target.files[0];
    if (!file) return;
    const parsed = JSON.parse(await file.text());
    loads = parsed.loads || [];
    company = parsed.company || {};
    saveJson(KEY, loads);
    saveJson(COMPANY_KEY, company);
    renderLoads();
    alert("Import complete.");
  });

  els.clearBtn.addEventListener("click", () => {
    if (!confirm("Clear all loads?")) return;
    loads = [];
    saveJson(KEY, loads);
    renderLoads();
  });

  els.saveBizBtn.addEventListener("click", () => {
    company = {
      bizName: document.getElementById("bizName").value.trim(),
      bizPhone: document.getElementById("bizPhone").value.trim(),
      bizEmail: document.getElementById("bizEmail").value.trim(),
      bizTerms: document.getElementById("bizTerms").value.trim(),
      bizAddress: document.getElementById("bizAddress").value.trim(),
      bizPay: document.getElementById("bizPay").value.trim(),
    };
    saveJson(COMPANY_KEY, company);
    alert("Company info saved.");
  });

  renderLoads();
});
</script>
</body>
</html>

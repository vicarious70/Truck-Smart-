<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>Trucking Made Simple</title>
  <style>
    :root{
      --bg:#0b0f17; --card:#121a27; --muted:#93a4bf; --text:#e7eefc;
      --acc:#57c4ff; --good:#41d38c; --bad:#ff5f73; --warn:#ffcc66;
      --line:#1f2a3c; --chip:#172238;
      --radius:16px;
      --shadow: 0 10px 30px rgba(0,0,0,.35);
      --pad:14px;
      --font: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
    }
    *{box-sizing:border-box}
    body{
      margin:0; font-family:var(--font); background:linear-gradient(180deg,#070a10,#0b0f17 40%);
      color:var(--text); padding:env(safe-area-inset-top) 12px env(safe-area-inset-bottom);
    }
    header{
      position:sticky; top:0; z-index:10;
      background:rgba(11,15,23,.78); backdrop-filter: blur(10px);
      border-bottom:1px solid var(--line);
      padding:10px 6px;
    }
    .topRow{display:flex; gap:10px; align-items:center; justify-content:space-between; flex-wrap:wrap}
    .title{display:flex; flex-direction:column; gap:2px}
    h1{font-size:16px; margin:0; letter-spacing:.2px}
    .sub{font-size:12px; color:var(--muted)}
    .tabs{display:flex; gap:8px; margin-top:10px; overflow:auto; padding-bottom:6px}
    .tab{
      border:1px solid var(--line); background:var(--chip); color:var(--text);
      padding:10px 12px; border-radius:999px; font-size:13px; white-space:nowrap;
      cursor:pointer; user-select:none;
    }
    .tab.active{border-color:rgba(87,196,255,.6); box-shadow:0 0 0 2px rgba(87,196,255,.18) inset}
    main{max-width:980px; margin:12px auto 60px}
    .grid{display:grid; grid-template-columns:1fr; gap:12px}
    @media(min-width:880px){ .grid{grid-template-columns:1.1fr .9fr} }
    .card{
      background:rgba(18,26,39,.92); border:1px solid var(--line);
      border-radius:var(--radius); box-shadow:var(--shadow); padding:var(--pad);
    }
    .card h2{margin:0 0 8px; font-size:15px}
    .row{display:grid; grid-template-columns:1fr; gap:10px; margin-top:10px}
    @media(min-width:640px){
      .row.two{grid-template-columns:1fr 1fr}
      .row.three{grid-template-columns:1fr 1fr 1fr}
    }
    label{display:flex; flex-direction:column; gap:6px; font-size:12px; color:var(--muted)}
    input, select, textarea{
      width:100%; border:1px solid var(--line); background:#0d1421; color:var(--text);
      border-radius:12px; padding:12px 12px; font-size:15px; outline:none;
    }
    textarea{min-height:80px; resize:vertical}
    input:focus, select:focus, textarea:focus{
      border-color:rgba(87,196,255,.7); box-shadow:0 0 0 3px rgba(87,196,255,.14);
    }
    .btnRow{display:flex; gap:10px; flex-wrap:wrap; margin-top:12px}
    button{
      border:1px solid var(--line); background:var(--chip); color:var(--text);
      padding:12px 14px; border-radius:12px; cursor:pointer; font-size:14px;
    }
    button.primary{border-color:rgba(87,196,255,.6); background:rgba(87,196,255,.12)}
    button.good{border-color:rgba(65,211,140,.55); background:rgba(65,211,140,.12)}
    button.bad{border-color:rgba(255,95,115,.55); background:rgba(255,95,115,.12)}
    .pill{
      display:inline-flex; gap:8px; align-items:center; padding:8px 10px;
      border-radius:999px; border:1px solid var(--line); background:rgba(0,0,0,.12);
      font-size:12px; color:var(--muted)
    }
    .kpis{display:flex; gap:10px; flex-wrap:wrap; margin-top:10px}
    .kpi{
      flex:1; min-width:160px; background:rgba(0,0,0,.12);
      border:1px solid var(--line); border-radius:14px; padding:10px 12px;
    }
    .kpi .label{color:var(--muted); font-size:12px}
    .kpi .val{font-size:18px; margin-top:6px}
    .val.good{color:var(--good)} .val.bad{color:var(--bad)} .val.warn{color:var(--warn)}
    .list{margin-top:12px; display:flex; flex-direction:column; gap:10px;}
    .item{
      border:1px solid var(--line); border-radius:14px; padding:12px;
      background:rgba(0,0,0,.10);
    }
    .itemTop{display:flex; justify-content:space-between; gap:10px; flex-wrap:wrap}
    .itemTitle{font-size:14px}
    .itemMeta{font-size:12px; color:var(--muted); margin-top:4px}
    .itemNums{display:flex; gap:12px; flex-wrap:wrap; margin-top:8px; color:var(--muted); font-size:12px}
    .mono{font-variant-numeric: tabular-nums}
    .hide{display:none !important}
    .hr{height:1px; background:var(--line); margin:12px 0}
    .small{font-size:12px; color:var(--muted)}
    .dangerBox{
      border:1px solid rgba(255,95,115,.5); background:rgba(255,95,115,.08);
      border-radius:14px; padding:10px 12px; color:#ffd7dd;
    }
    .successBox{
      border:1px solid rgba(65,211,140,.5); background:rgba(65,211,140,.08);
      border-radius:14px; padding:10px 12px; color:#d7ffef;
    }
    .toast{
      position:fixed; left:50%; transform:translateX(-50%);
      bottom:16px; z-index:50;
      background:rgba(0,0,0,.72); border:1px solid var(--line);
      padding:10px 12px; border-radius:999px; color:var(--text);
      font-size:13px; max-width:92vw; backdrop-filter: blur(10px);
      pointer-events:none;
    }

    /* =========================
       Invoice Preview (in-app)
    ========================= */
    .invoicePaper{
      background:#ffffff;
      color:#111;
      border-radius:14px;
      padding:18px;
      border:1px solid rgba(255,255,255,.08);
      overflow:auto;
    }
    .invoicePaper *{ box-sizing:border-box; }
    .invTop{
      display:flex;
      justify-content:space-between;
      gap:14px;
      flex-wrap:wrap;
      align-items:flex-start;
      margin-bottom:12px;
    }
    .invH{
      font-size:18px;
      font-weight:700;
      margin:0;
      color:#111;
    }
    .invMuted{ color:#555; font-size:12px; }
    .invBlock{
      border:1px solid #e6e6e6;
      border-radius:12px;
      padding:12px;
      margin-top:10px;
    }
    .invGrid2{
      display:grid;
      grid-template-columns:1fr;
      gap:10px;
    }
    @media(min-width:640px){ .invGrid2{ grid-template-columns:1fr 1fr; } }
    .invTable{
      width:100%;
      border-collapse:collapse;
      margin-top:10px;
      font-size:13px;
    }
    .invTable th, .invTable td{
      border-bottom:1px solid #eee;
      padding:10px 8px;
      text-align:left;
      vertical-align:top;
    }
    .invTable th{ color:#444; font-weight:700; }
    .invRight{ text-align:right; }
    .invTotal{
      display:flex;
      justify-content:flex-end;
      margin-top:10px;
      font-size:14px;
    }
    .invTotalBox{
      min-width:260px;
      border:1px solid #eee;
      border-radius:12px;
      padding:12px;
      background:#fafafa;
    }
    .invLine{
      display:flex; justify-content:space-between; gap:10px;
      padding:4px 0;
      font-variant-numeric: tabular-nums;
    }
    .invBig{
      font-size:16px;
      font-weight:800;
      border-top:1px solid #eee;
      margin-top:8px;
      padding-top:8px;
    }

    /* =========================
       PRINT: invoice-only output
    ========================= */
@media print {
  @page { margin: 12mm; }

  html, body {
    background:#fff !important;
    color:#111 !important;
    height:auto !important;
  }

  /* KEY FIX: don't "display:none" main/header because invoicePreview is inside main.
     Instead, hide everything via visibility, then reveal only #invoicePreview. */
  body * {
    visibility: hidden !important;
  }

  /* If the invoices tab section was hidden (.hide), force it to exist for print */
  #tab-invoices, #tab-invoices.hide {
    display: block !important;
  }

  /* Reveal invoicePreview */
  #invoicePreview, #invoicePreview * {
    visibility: visible !important;
  }

  /* Position invoice at top-left for clean printing */
  #invoicePreview {
    position: absolute !important;
    left: 0 !important;
    top: 0 !important;
    width: 100% !important;

    margin: 0 !important;
    padding: 0 !important;

    border: none !important;
    border-radius: 0 !important;
    box-shadow: none !important;

    background: #fff !important;
    color:#111 !important;
    overflow: visible !important;
  }

  /* Paper styling: remove in-app card vibes */
  .invoicePaper{
    border:none !important;
    border-radius:0 !important;
    box-shadow:none !important;
    padding:0 !important;
    margin:0 !important;
    background:#fff !important;
    overflow: visible !important;
  }

  /* Keep key blocks together where possible */
  .invTop, .invBlock, .invTotal, .invTotalBox, .invSigRow, .invMetaGrid {
    break-inside: avoid;
    page-break-inside: avoid;
  }

  /* Tables flow nicely across pages */
  table { width:100% !important; border-collapse:collapse !important; }
  thead { display: table-header-group; }
  tfoot { display: table-footer-group; }

  tr, td, th {
    break-inside: avoid;
    page-break-inside: avoid;
  }

  /* Print colors reliably */
  * {
    -webkit-print-color-adjust: exact !important;
    print-color-adjust: exact !important;
  }
}

      /* Don‚Äôt clip content */
      * { overflow: visible !important; }

      /* Keep colors (Chrome sometimes fades them) */
      * {
        -webkit-print-color-adjust: exact !important;
        print-color-adjust: exact !important;
      }
    }
  </style>
</head>

<body>
<header>
  <div class="topRow">
    <div class="title">
      <h1>Trucking Made Simple</h1>
      <div class="sub">Offline. Stores on your phone. Built because spreadsheets hate joy.</div>
    </div>
    <div class="pill" id="statusPill">‚úÖ Ready</div>
  </div>
  <div class="tabs">
    <div class="tab active" data-tab="trips">üöõ Trips</div>
    <div class="tab" data-tab="budget">üè† Budget</div>
    <div class="tab" data-tab="dashboard">üìä Dashboard</div>
    <div class="tab" data-tab="invoices">üßæ Invoices</div>
    <div class="tab" data-tab="settings">‚öôÔ∏è Settings</div>
  </div>
</header>

<main>
  <!-- TRIPS -->
  <section id="tab-trips" class="grid">
    <div class="card">
      <h2>New Trip / Load</h2>
      <div class="row two">
        <label>Date
          <input id="t_date" type="date" />
        </label>
        <label>Company (dropdown)
          <select id="t_company"></select>
        </label>
      </div>

      <div class="row three">
        <label>Truck #
          <select id="t_truck"></select>
        </label>
        <label>Trailer #
          <select id="t_trailer"></select>
        </label>
        <label>Tire Size
          <select id="t_tire"></select>
        </label>
      </div>

      <div class="row two">
        <label>Shipper
          <select id="t_shipper"></select>
        </label>
        <label>Load / Reference #
          <input id="t_ref" placeholder="Optional: load ID" />
        </label>
      </div>

      <div class="row two">
        <label>Pickup City/State
          <select id="t_pickup"></select>
        </label>
        <label>Delivery City/State
          <select id="t_delivery"></select>
        </label>
      </div>

      <div class="row two">
        <label>Pickup Address
          <input id="t_pickup_addr" placeholder="Street, city, state" />
        </label>
        <label>Delivery Address
          <input id="t_delivery_addr" placeholder="Street, city, state" />
        </label>
      </div>

      <div class="row two">
        <label>Broker / Customer
          <select id="t_customer"></select>
        </label>
        <label>Consignee
          <select id="t_consignee"></select>
        </label>
      </div>

      <div class="row three">
        <label>Loaded Miles
          <input id="t_loaded_miles" type="number" min="0" step="1" placeholder="0" />
        </label>
        <label>Deadhead Miles (last drop ‚Üí next pickup)
          <input id="t_deadhead_miles" type="number" min="0" step="1" placeholder="0" />
        </label>
        <label>Rate / Trip Revenue ($)
          <input id="t_revenue" type="number" min="0" step="0.01" placeholder="0.00" />
        </label>
      </div>

      <div class="hr"></div>

      <h2>Fuel + Trip Costs</h2>
      <div class="row three">
        <label>Fuel Gallons Purchased
          <input id="t_fuel_gal" type="number" min="0" step="0.01" placeholder="0.00" />
        </label>
        <label>Avg Fuel Cost per Gallon ($)
          <input id="t_fuel_cpg" type="number" min="0" step="0.001" placeholder="0.000" />
        </label>
        <label>Tolls ($)
          <input id="t_tolls" type="number" min="0" step="0.01" placeholder="0.00" />
        </label>
      </div>

      <div class="row two">
        <label>Other Trip Expenses ($)
          <input id="t_other" type="number" min="0" step="0.01" placeholder="0.00" />
        </label>
        <label>Notes
          <input id="t_notes" placeholder="Anything you want to remember" />
        </label>
      </div>

      <div class="hr"></div>

      <h2>Reserves (auto or manual)</h2>
      <div class="small">Set default per-mile reserves in ‚öôÔ∏è Settings. You can override here per trip.</div>
      <div class="row three">
        <label>Tire Reserve ($)
          <input id="t_res_tires" type="number" min="0" step="0.01" placeholder="auto" />
        </label>
        <label>Maintenance Reserve ($)
          <input id="t_res_maint" type="number" min="0" step="0.01" placeholder="auto" />
        </label>
        <label>Plates Reserve ($)
          <input id="t_res_plates" type="number" min="0" step="0.01" placeholder="auto" />
        </label>
      </div>

      <div class="row two">
        <label>IFTA Reserve ($) (estimate)
          <input id="t_res_ifta" type="number" min="0" step="0.01" placeholder="auto" />
        </label>
        <label>Tax Reserve ($) (estimate)
          <input id="t_res_tax" type="number" min="0" step="0.01" placeholder="auto" />
        </label>
      </div>

      <div class="btnRow">
        <button type="button" class="primary" id="btn_calc">üßÆ Calculate</button>
        <button type="button" class="good" id="btn_save">üíæ Save Trip</button>
        <button type="button" class="bad" id="btn_clear">üßΩ Clear</button>
      </div>

      <div class="kpis">
        <div class="kpi"><div class="label">Total Miles</div><div class="val mono" id="k_total_miles">0</div></div>
        <div class="kpi"><div class="label">Fuel Cost</div><div class="val mono" id="k_fuel_cost">$0.00</div></div>
        <div class="kpi"><div class="label">MPG (est)</div><div class="val mono" id="k_mpg">0.00</div></div>
        <div class="kpi"><div class="label">Trip Net</div><div class="val mono" id="k_net">$0.00</div></div>
      </div>

      <div class="hr"></div>
      <div class="small">
        ‚ö†Ô∏è IFTA here is an <i>estimate</i> unless you track miles + gallons by state.
        This app includes a reserve estimate so you‚Äôre not surprised later.
      </div>
    </div>

    <div class="card">
      <h2>Search Past Trips</h2>
      <label>Search (company, shipper, pickup, delivery, ref, notes)
        <input id="searchTrips" placeholder="type to filter..." />
      </label>
      <div class="btnRow">
        <button type="button" id="btn_export">‚¨áÔ∏è Export Data</button>
        <button type="button" id="btn_import">‚¨ÜÔ∏è Import Data</button>
        <input id="importFile" type="file" accept="application/json" class="hide" />
      </div>

      <div class="hr"></div>
      <div class="list" id="tripList"></div>
    </div>
  </section>

  <!-- BUDGET -->
  <section id="tab-budget" class="grid hide">
    <div class="card">
      <h2>Monthly Personal Budget</h2>
      <div class="row two">
        <label>Month
          <input id="b_month" type="month" />
        </label>
        <label>Comfort Buffer (%)
          <input id="b_buffer" type="number" min="0" step="1" placeholder="15" />
        </label>
      </div>

      <div class="row three">
        <label>Paychecks per Month
          <select id="b_paychecks">
            <option value="2">2 (biweekly-ish)</option>
            <option value="4">4 (weekly)</option>
            <option value="1">1 (monthly)</option>
          </select>
        </label>
        <label>Estimated Tax/Withholding (%)
          <input id="b_withhold" type="number" min="0" step="1" placeholder="20" />
        </label>
        <label>Other Monthly Income ($)
          <input id="b_other_income" type="number" min="0" step="0.01" placeholder="0.00" />
        </label>
      </div>

      <div class="hr"></div>

      <h2>Add Expense</h2>
      <div class="row two">
        <label>Category
          <select id="b_cat"></select>
        </label>
        <label>Amount ($)
          <input id="b_amt" type="number" min="0" step="0.01" placeholder="0.00" />
        </label>
      </div>
      <div class="row">
        <label>Note (optional)
          <input id="b_note" placeholder="ex: Netflix, rent, car insurance..." />
        </label>
      </div>

      <div class="btnRow">
        <button type="button" class="good" id="btn_add_exp">‚ûï Add</button>
        <button type="button" class="primary" id="btn_budget_calc">üßÆ Calculate Paycheck Needed</button>
        <button type="button" class="bad" id="btn_budget_clear">üßΩ Clear Month</button>
      </div>

      <div class="kpis">
        <div class="kpi"><div class="label">Total Monthly Expenses</div><div class="val mono" id="k_b_total">$0.00</div></div>
        <div class="kpi"><div class="label">Needed (Gross)</div><div class="val mono" id="k_b_gross">$0.00</div></div>
        <div class="kpi"><div class="label">Needed Per Paycheck (Gross)</div><div class="val mono" id="k_b_percheck">$0.00</div></div>
        <div class="kpi"><div class="label">Needed (Net after Withholding)</div><div class="val mono" id="k_b_net">$0.00</div></div>
      </div>

      <div class="hr"></div>
      <div class="list" id="budgetList"></div>
    </div>

    <div class="card">
      <h2>Monthly Goals</h2>
      <div class="row two">
        <label>Business Monthly Revenue Goal ($)
          <input id="g_biz" type="number" min="0" step="0.01" placeholder="0.00" />
        </label>
        <label>Personal Monthly Income Goal ($)
          <input id="g_personal" type="number" min="0" step="0.01" placeholder="0.00" />
        </label>
      </div>
      <div class="btnRow">
        <button type="button" class="good" id="btn_save_goals">üíæ Save Goals</button>
      </div>
      <div id="goalMsg" class="small"></div>

      <div class="hr"></div>
      <div class="small">
        Goals are compared against your saved trips (revenue) and your budget calculator (needed income).
      </div>
    </div>
  </section>

  <!-- DASHBOARD -->
  <section id="tab-dashboard" class="grid hide">
    <div class="card">
      <h2>Business Dashboard</h2>
      <div class="row two">
        <label>Year
          <select id="d_year"></select>
        </label>
        <label>Filter Month (optional)
          <input id="d_month" type="month" />
        </label>
      </div>
      <div class="btnRow">
        <button type="button" class="primary" id="btn_dash">üìä Refresh</button>
      </div>

      <div class="kpis">
        <div class="kpi"><div class="label">Revenue</div><div class="val mono" id="d_rev">$0.00</div></div>
        <div class="kpi"><div class="label">Expenses</div><div class="val mono" id="d_exp">$0.00</div></div>
        <div class="kpi"><div class="label">Net</div><div class="val mono" id="d_net">$0.00</div></div>
        <div class="kpi"><div class="label">Miles</div><div class="val mono" id="d_miles">0</div></div>
      </div>

      <div class="hr"></div>
      <div id="dashGoalBox" class="dangerBox hide"></div>
      <div id="dashGoalOk" class="successBox hide"></div>

      <div class="hr"></div>
      <div class="small">
        YTD is based on trips saved on this phone. Export/import if you switch devices.
      </div>
    </div>

    <div class="card">
      <h2>Quick Insights</h2>
      <div class="list" id="insights"></div>
    </div>
  </section>

  <!-- INVOICES -->
  <section id="tab-invoices" class="grid hide">
    <div class="card">
      <h2>Invoices</h2>
      <div class="small">Pick a saved trip, preview the invoice, then print (or ‚ÄúSave as PDF‚Äù).</div>

      <div class="row">
        <label>Select Trip / Load
          <select id="inv_trip"></select>
        </label>
      </div>

      <div class="row two">
        <label>Invoice Date (optional override)
          <input id="inv_date" type="date" />
        </label>
        <label>Invoice # (optional override)
          <input id="inv_number" placeholder="auto" />
        </label>
      </div>

      <div class="btnRow">
        <button type="button" class="primary" id="btn_inv_preview">üßæ Build Preview</button>
        <button type="button" class="good" id="btn_inv_print">üñ®Ô∏è Print / Save PDF</button>
      </div>

      <div class="hr"></div>
      <div id="invoicePreview" class="invoicePaper">
        <div class="invMuted">No invoice selected yet.</div>
      </div>

      <div class="hr"></div>
      <div class="small">
        Tip: On iPhone/Android, use the browser share/print options to save as PDF.
      </div>
    </div>

    <div class="card">
      <h2>What prints</h2>
      <div class="small">
        Print now shows ONLY the invoice preview. (No header, no tabs, no ‚Äúapp‚Äù junk.)
      </div>
    </div>
  </section>

  <!-- SETTINGS -->
  <section id="tab-settings" class="grid hide">
    <div class="card">
      <h2>Dropdown Lists</h2>
      <div class="small">Edit lists, then hit Save.</div>

      <div class="row two">
        <label>Companies (one per line)
          <textarea id="s_companies"></textarea>
        </label>
        <label>Shippers (one per line)
          <textarea id="s_shippers"></textarea>
        </label>
      </div>

      <div class="row two">
        <label>Pickup/Delivery Locations (City, ST) one per line
          <textarea id="s_locations"></textarea>
        </label>
        <label>Tire Sizes (one per line)
          <textarea id="s_tires"></textarea>
        </label>
      </div>

      <div class="row two">
        <label>Truck Numbers (one per line)
          <textarea id="s_trucks"></textarea>
        </label>
        <label>Trailer Numbers (one per line)
          <textarea id="s_trailers"></textarea>
        </label>
      </div>

      <div class="row two">
        <label>Customers / Brokers (one per line)
          <textarea id="s_customers"></textarea>
        </label>
        <label>Consignees (one per line)
          <textarea id="s_consignees"></textarea>
        </label>
      </div>

      <div class="btnRow">
        <button type="button" class="good" id="btn_save_lists">üíæ Save Lists</button>
        <button type="button" class="bad" id="btn_reset_lists">‚Ü©Ô∏è Reset Defaults</button>
      </div>
    </div>

    <div class="card">
      <h2>Default Reserves & Rates</h2>
      <div class="small">These feed auto-calcs for every trip. You can override per trip.</div>

      <div class="row three">
        <label>Tire Reserve ($ per mile)
          <input id="r_tires" type="number" min="0" step="0.001" />
        </label>
        <label>Maintenance Reserve ($ per mile)
          <input id="r_maint" type="number" min="0" step="0.001" />
        </label>
        <label>Plates Reserve ($ per mile)
          <input id="r_plates" type="number" min="0" step="0.001" />
        </label>
      </div>
      <div class="row three">
        <label>IFTA Reserve ($ per mile) (estimate)
          <input id="r_ifta" type="number" min="0" step="0.001" />
        </label>
        <label>Tax Reserve (% of revenue)
          <input id="r_tax_pct" type="number" min="0" step="0.1" />
        </label>
        <label>Target MPG (for estimates if gallons missing)
          <input id="r_mpg" type="number" min="1" step="0.1" />
        </label>
      </div>

      <div class="btnRow">
        <button type="button" class="good" id="btn_save_rates">üíæ Save Rates</button>
      </div>

      <div class="hr"></div>
      <div class="dangerBox">
        <b>IFTA note:</b> Real IFTA requires miles + gallons by jurisdiction. This app uses a reserve estimate so you don‚Äôt get wrecked later.
      </div>
    </div>

    <div class="card">
      <h2>Budget Categories</h2>
      <div class="small">One per line.</div>
      <textarea id="s_budget_cats"></textarea>
      <div class="btnRow">
        <button type="button" class="good" id="btn_save_budget_cats">üíæ Save Categories</button>
      </div>

      <div class="hr"></div>
      <button type="button" class="bad" id="btn_nuke">üß® Delete ALL Data (Danger)</button>
      <div class="small">This wipes trips, budget, goals. There is no undo.</div>
    </div>
  </section>
</main>

<div id="toast" class="toast hide">Saved.</div>

<script type="text/javascript">
  console.log("SCRIPT START");

function setStatus(text){
  const pill = document.getElementById("statusPill");
  if(pill) pill.textContent = text;
}
window.addEventListener("error", (e)=>{
  console.error("JS Error:", e?.error || e?.message || e);
  setStatus("‚ùå Error (open Console)");
});
window.addEventListener("unhandledrejection", (e)=>{
  console.error("Unhandled Promise Rejection:", e?.reason || e);
  setStatus("‚ùå Error (open Console)");
});

document.addEventListener("DOMContentLoaded", () => {
  try {
    if (typeof structuredClone !== "function") {
      window.structuredClone = (obj) => JSON.parse(JSON.stringify(obj));
    }
    if (!window.crypto) window.crypto = {};
    if (typeof window.crypto.randomUUID !== "function") {
      window.crypto.randomUUID = () => {
        return "xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g, (c) => {
          const r = (Math.random() * 16) | 0;
          const v = c === "x" ? r : (r & 0x3) | 0x8;
          return v.toString(16);
        });
      };
    }

    const LS_KEY = "truckBudgetTracker.v1";
    const money = (n)=> (isFinite(n) ? n : 0);
    const fmtMoney = (n)=> "$" + money(n).toFixed(2);
    const fmtNum = (n)=> (isFinite(n) ? n : 0).toLocaleString();

    const defaults = {
      lists: {
        companies: ["Select‚Ä¶","ACME Logistics","Blue River Transport"],
        shippers: ["Select‚Ä¶","Amazon","Walmart DC","Target DC"],
        locations: ["Select‚Ä¶","Atlanta, GA","Dallas, TX","Chicago, IL","Newark, NJ"],
        tires: ["Select‚Ä¶","22.5","24.5","11R22.5"],
        trucks: ["Select‚Ä¶","101","102","103"],
        trailers: ["Select‚Ä¶","T-201","T-202","T-203"],
        budgetCats: [
          "Household expenses","Groceries","Entertainment","Mortgage/Rent",
          "Car note","Utilities","Phone/Internet","Insurance","Gas/Transportation",
          "Personal","Savings","Medical"
        ],
        customers: ["Select‚Ä¶","CH Robinson","TQL","JB Hunt"],
        consignees: ["Select‚Ä¶","Walmart DC","Amazon FC","Costco DC"]
      },
      rates: {
        tiresPerMile: 0.05,
        maintPerMile: 0.12,
        platesPerMile: 0.02,
        iftaPerMile: 0.03,
        taxPctRevenue: 22,
        targetMPG: 6.5
      },
      goals: { bizMonthly: 0, personalMonthly: 0 },
      trips: [],
      budget: {}
    };

    function loadState(){
      try{
        const raw = localStorage.getItem(LS_KEY);
        if(!raw) return structuredClone(defaults);
        const parsed = JSON.parse(raw);
        return {
          ...structuredClone(defaults),
          ...parsed,
          lists: { ...structuredClone(defaults.lists), ...(parsed.lists||{}) },
          rates: { ...structuredClone(defaults.rates), ...(parsed.rates||{}) },
          goals: { ...structuredClone(defaults.goals), ...(parsed.goals||{}) },
          trips: Array.isArray(parsed.trips) ? parsed.trips : [],
          budget: parsed.budget || {}
        };
      } catch(e){
        return structuredClone(defaults);
      }
    }
    function saveState(){ localStorage.setItem(LS_KEY, JSON.stringify(state)); }
    let state = loadState();

    const $ = (id)=> document.getElementById(id);

    function on(id, event, fn){
      const el = $(id);
      if(!el){
        console.warn("Missing element:", "#" + id);
        return;
      }
      el.addEventListener(event, fn);
    }

    function toast(msg){
      const t = $("toast");
      if(!t) return;
      t.textContent = msg;
      t.classList.remove("hide");
      setTimeout(()=> t.classList.add("hide"), 1700);
    }

    function fillSelect(selectEl, arr){
      if(!selectEl) return;
      selectEl.innerHTML = "";
      (arr || []).forEach(v=>{
        const opt = document.createElement("option");
        opt.value = v;
        opt.textContent = v;
        selectEl.appendChild(opt);
      });
    }

    function todayISO(){
      const d = new Date();
      const off = d.getTimezoneOffset();
      const local = new Date(d.getTime() - off*60000);
      return local.toISOString().slice(0,10);
    }
    function isoNowDate(){ return todayISO(); }

    function ensureSelect(arr){
      if(arr[0] !== "Select‚Ä¶") arr.unshift("Select‚Ä¶");
      return arr;
    }
    function escapeHtml(s){
      return String(s||"").replace(/[&<>"']/g, c=>({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;" }[c]));
    }

    document.querySelectorAll(".tab").forEach(tab=>{
      tab.addEventListener("click", ()=>{
        document.querySelectorAll(".tab").forEach(t=>t.classList.remove("active"));
        tab.classList.add("active");
        const name = tab.dataset.tab;

        ["trips","budget","dashboard","invoices","settings"].forEach(n=>{
          const sec = $("tab-"+n);
          if(sec) sec.classList.toggle("hide", n!==name);
        });

        if(name==="dashboard") refreshDashboard();
        if(name==="settings") loadSettingsUI();
        if(name==="budget") loadBudgetUI();
        if(name==="trips") renderTrips();
        if(name==="invoices") loadInvoicesUI();
      });
    });

    function loadTripDropdowns(){
      fillSelect($("t_company"), state.lists.companies);
      fillSelect($("t_shipper"), state.lists.shippers);
      fillSelect($("t_pickup"), state.lists.locations);
      fillSelect($("t_delivery"), state.lists.locations);
      fillSelect($("t_tire"), state.lists.tires);
      fillSelect($("t_truck"), state.lists.trucks);
      fillSelect($("t_trailer"), state.lists.trailers);
      fillSelect($("t_customer"), state.lists.customers);
      fillSelect($("t_consignee"), state.lists.consignees);
    }

    function readTripForm(){
      const loaded = money(parseFloat($("t_loaded_miles")?.value));
      const deadhead = money(parseFloat($("t_deadhead_miles")?.value));
      const miles = loaded + deadhead;

      const revenue = money(parseFloat($("t_revenue")?.value));
      const gal = money(parseFloat($("t_fuel_gal")?.value));
      const cpg = money(parseFloat($("t_fuel_cpg")?.value));
      const fuelCost = gal * cpg;

      const tolls = money(parseFloat($("t_tolls")?.value));
      const other = money(parseFloat($("t_other")?.value));

      const autoTires = miles * state.rates.tiresPerMile;
      const autoMaint = miles * state.rates.maintPerMile;
      const autoPlates = miles * state.rates.platesPerMile;
      const autoIFTA  = miles * state.rates.iftaPerMile;
      const autoTax   = revenue * (state.rates.taxPctRevenue/100);

      const resTires = ($("t_res_tires")?.value || "").trim()==="" ? autoTires : money(parseFloat($("t_res_tires").value));
      const resMaint = ($("t_res_maint")?.value || "").trim()==="" ? autoMaint : money(parseFloat($("t_res_maint").value));
      const resPlates= ($("t_res_plates")?.value||"").trim()==="" ? autoPlates: money(parseFloat($("t_res_plates").value));
      const resIFTA  = ($("t_res_ifta")?.value||"").trim()==="" ? autoIFTA  : money(parseFloat($("t_res_ifta").value));
      const resTax   = ($("t_res_tax")?.value||"").trim()===""  ? autoTax   : money(parseFloat($("t_res_tax").value));

      let mpg = 0;
      if(gal>0 && miles>0) mpg = miles / gal;
      else if(miles>0) mpg = state.rates.targetMPG;

      const totalExpenses = fuelCost + tolls + other + resTires + resMaint + resPlates + resIFTA + resTax;
      const net = revenue - totalExpenses;

      return {
        date: $("t_date")?.value || todayISO(),
        company: $("t_company")?.value,
        truck: $("t_truck")?.value,
        trailer: $("t_trailer")?.value,
        tireSize: $("t_tire")?.value,
        shipper: $("t_shipper")?.value,
        ref: ($("t_ref")?.value || "").trim(),
        pickup: $("t_pickup")?.value,
        pickupAddr: ($("t_pickup_addr")?.value || "").trim(),
        delivery: $("t_delivery")?.value,
        deliveryAddr: ($("t_delivery_addr")?.value || "").trim(),
        customer: $("t_customer")?.value,
        consignee: $("t_consignee")?.value,
        loadedMiles: loaded,
        deadheadMiles: deadhead,
        totalMiles: miles,
        revenue,
        fuelGallons: gal,
        fuelCostPerGallon: cpg,
        fuelCost,
        tolls,
        other,
        reserves: { tires:resTires, maint:resMaint, plates:resPlates, ifta:resIFTA, tax:resTax },
        totals: { totalExpenses, net, mpg },
        notes: ($("t_notes")?.value || "").trim(),
        id: crypto.randomUUID()
      };
    }

    function updateTripKPIs(t){
      if($("k_total_miles")) $("k_total_miles").textContent = fmtNum(t.totalMiles);
      if($("k_fuel_cost")) $("k_fuel_cost").textContent = fmtMoney(t.fuelCost);
      if($("k_mpg")) $("k_mpg").textContent = (t.totals.mpg||0).toFixed(2);
      const netEl = $("k_net");
      if(netEl){
        netEl.textContent = fmtMoney(t.totals.net);
        netEl.classList.remove("good","bad","warn");
        netEl.classList.add(t.totals.net>=0 ? "good" : "bad");
      }
    }

    function renderTrips(){
      const q = (($("searchTrips")?.value)||"").toLowerCase().trim();
      const list = $("tripList");
      if(!list) return;
      list.innerHTML = "";

      const filtered = state.trips.filter(t=>{
        if(!q) return true;
        const blob = [
          t.company,t.shipper,t.pickup,t.delivery,t.ref,t.notes,t.truck,t.trailer,
          t.customer,t.consignee
        ].join(" ").toLowerCase();
        return blob.includes(q);
      });

      if(filtered.length===0){
        const div = document.createElement("div");
        div.className="small";
        div.textContent = state.trips.length===0 ? "No trips saved yet." : "No matches.";
        list.appendChild(div);
        return;
      }

      filtered.slice(0,200).forEach(t=>{
        const item = document.createElement("div");
        item.className="item";

        const top = document.createElement("div");
        top.className="itemTop";
        top.innerHTML = `
          <div>
            <div class="itemTitle"><b>${escapeHtml(t.company)}</b> ¬∑ ${escapeHtml(t.pickup)} ‚Üí ${escapeHtml(t.delivery)}</div>
                        <div class="itemMeta mono">${escapeHtml(t.date)}
              ¬∑ Truck ${escapeHtml(t.truck)} / Trailer ${escapeHtml(t.trailer)}
              ${t.ref ? " ¬∑ Ref " + escapeHtml(t.ref) : ""}
            </div>
          </div>
          <div class="btnRow" style="margin-top:0">
            <button type="button" data-act="invoice" data-id="${escapeHtml(t.id)}">üßæ Invoice</button>
            <button type="button" class="bad" data-act="delete" data-id="${escapeHtml(t.id)}">üóëÔ∏è Delete</button>
          </div>
        `;

        const nums = document.createElement("div");
        nums.className="itemNums mono";
        nums.innerHTML = `
          <div>Miles: <b>${fmtNum(t.totalMiles)}</b></div>
          <div>Revenue: <b>${fmtMoney(t.revenue)}</b></div>
          <div>Expenses: <b>${fmtMoney(t.totals?.totalExpenses||0)}</b></div>
          <div>Net: <b style="color:${(t.totals?.net||0)>=0 ? "var(--good)" : "var(--bad)"}">${fmtMoney(t.totals?.net||0)}</b></div>
        `;

        item.appendChild(top);
        item.appendChild(nums);

        item.addEventListener("click", (e)=>{
          const btn = e.target.closest("button");
          if(!btn) return;
          e.stopPropagation();
          const act = btn.dataset.act;
          const id = btn.dataset.id;
          if(act==="delete") deleteTrip(id);
          if(act==="invoice") {
            // switch to invoice tab and select
            document.querySelectorAll(".tab").forEach(t=>t.classList.remove("active"));
            document.querySelector('.tab[data-tab="invoices"]')?.classList.add("active");
            ["trips","budget","dashboard","invoices","settings"].forEach(n=>{
              const sec = $("tab-"+n);
              if(sec) sec.classList.toggle("hide", n!=="invoices");
            });
            loadInvoicesUI(id);
          }
        });

        list.appendChild(item);
      });
    }

    function clearTripForm(){
      [
        "t_date","t_company","t_truck","t_trailer","t_tire","t_shipper","t_ref",
        "t_pickup","t_pickup_addr","t_delivery","t_delivery_addr",
        "t_customer","t_consignee",
        "t_loaded_miles","t_deadhead_miles","t_revenue","t_fuel_gal","t_fuel_cpg","t_tolls","t_other",
        "t_res_tires","t_res_maint","t_res_plates","t_res_ifta","t_res_tax","t_notes"
      ].forEach(id=>{
        const el = $(id);
        if(!el) return;
        if(el.tagName==="SELECT") el.selectedIndex = 0;
        else el.value = "";
      });
      $("t_date").value = todayISO();
      updateTripKPIs(readTripForm());
    }

    function deleteTrip(id){
      const idx = state.trips.findIndex(t=>t.id===id);
      if(idx<0) return;
      state.trips.splice(idx,1);
      saveState();
      toast("Deleted trip");
      renderTrips();
      loadInvoicesUI(); // refresh invoice dropdown
      refreshDashboard();
    }

    function calcTrip(){
      const t = readTripForm();
      updateTripKPIs(t);
      return t;
    }

    function saveTrip(){
      const t = calcTrip();

      // basic validation: prevent saving "Select‚Ä¶" placeholders as real values
      const required = [
        ["company","Company"],["truck","Truck #"],["trailer","Trailer #"],
        ["shipper","Shipper"],["pickup","Pickup"],["delivery","Delivery"],
        ["customer","Broker/Customer"],["consignee","Consignee"]
      ];
      const missing = required.filter(([k])=> !t[k] || t[k]==="Select‚Ä¶").map(([,label])=>label);
      if(missing.length){
        toast("Missing: " + missing.join(", "));
        return;
      }

      state.trips.unshift(t);
      // keep newest first but don‚Äôt let it bloat forever
      state.trips = state.trips.slice(0,3000);
      saveState();
      toast("Saved trip");
      renderTrips();
      loadInvoicesUI();
      refreshDashboard();
    }

    // ========= Budget =========
    function loadBudgetUI(){
      fillSelect($("b_cat"), ensureSelect((state.lists.budgetCats||[]).slice()));
      if(!$("b_month").value) $("b_month").value = new Date().toISOString().slice(0,7);
      if(!$("b_buffer").value) $("b_buffer").value = 15;
      if(!$("b_withhold").value) $("b_withhold").value = 20;
      if(!$("b_other_income").value) $("b_other_income").value = 0;
      renderBudget();
    }

    function budgetKey(){
      return ($("b_month")?.value || new Date().toISOString().slice(0,7));
    }

    function getMonthBudget(){
      const key = budgetKey();
      if(!state.budget[key]) state.budget[key] = [];
      if(!Array.isArray(state.budget[key])) state.budget[key] = [];
      return state.budget[key];
    }

    function renderBudget(){
      const list = $("budgetList");
      if(!list) return;
      list.innerHTML = "";
      const items = getMonthBudget();

      if(items.length===0){
        const div = document.createElement("div");
        div.className="small";
        div.textContent = "No expenses saved for this month.";
        list.appendChild(div);
      } else {
        items.forEach((x, i)=>{
          const item = document.createElement("div");
          item.className="item";
          item.innerHTML = `
            <div class="itemTop">
              <div>
                <div class="itemTitle"><b>${escapeHtml(x.cat)}</b> ¬∑ ${fmtMoney(x.amt)}</div>
                <div class="itemMeta">${escapeHtml(x.note||"")}</div>
              </div>
              <div class="btnRow" style="margin-top:0">
                <button type="button" class="bad" data-i="${i}">üóëÔ∏è</button>
              </div>
            </div>
          `;
          item.querySelector("button")?.addEventListener("click", (e)=>{
            e.stopPropagation();
            const idx = parseInt(e.target.dataset.i,10);
            items.splice(idx,1);
            saveState();
            renderBudget();
            calcBudget();
            refreshDashboard();
          });
          list.appendChild(item);
        });
      }

      calcBudget();
    }

    function addExpense(){
      const cat = $("b_cat")?.value;
      const amt = money(parseFloat($("b_amt")?.value));
      const note = ($("b_note")?.value||"").trim();

      if(!cat || cat==="Select‚Ä¶"){ toast("Pick a category"); return; }
      if(!(amt>0)){ toast("Enter an amount"); return; }

      const items = getMonthBudget();
      items.unshift({ cat, amt, note, id: crypto.randomUUID() });
      saveState();
      $("b_amt").value = "";
      $("b_note").value = "";
      toast("Added");
      renderBudget();
      refreshDashboard();
    }

    function calcBudget(){
      const items = getMonthBudget();
      const total = items.reduce((a,x)=>a+money(x.amt),0);

      const bufferPct = money(parseFloat($("b_buffer")?.value));
      const withholdPct = money(parseFloat($("b_withhold")?.value));
      const otherIncome = money(parseFloat($("b_other_income")?.value));
      const paychecks = parseInt($("b_paychecks")?.value || "2",10) || 2;

      const buffered = total * (1 + (bufferPct/100));
      // you want to cover expenses minus other monthly income
      const neededNet = Math.max(0, buffered - otherIncome);
      // gross required before withholding
      const neededGross = (withholdPct>=100) ? 0 : (neededNet / (1 - withholdPct/100));
      const perCheck = paychecks>0 ? neededGross / paychecks : neededGross;

      if($("k_b_total")) $("k_b_total").textContent = fmtMoney(total);
      if($("k_b_gross")) $("k_b_gross").textContent = fmtMoney(neededGross);
      if($("k_b_percheck")) $("k_b_percheck").textContent = fmtMoney(perCheck);
      if($("k_b_net")) $("k_b_net").textContent = fmtMoney(neededNet);

      return { total, neededGross, perCheck, neededNet };
    }

    function clearBudgetMonth(){
      const key = budgetKey();
      state.budget[key] = [];
      saveState();
      toast("Cleared month");
      renderBudget();
      refreshDashboard();
    }

    // ========= Goals =========
    function saveGoals(){
      state.goals.bizMonthly = money(parseFloat($("g_biz")?.value));
      state.goals.personalMonthly = money(parseFloat($("g_personal")?.value));
      saveState();
      $("goalMsg").textContent = "Saved ‚úÖ";
      setTimeout(()=> $("goalMsg").textContent="", 1400);
      refreshDashboard();
    }

    // ========= Dashboard =========
    function refreshDashboard(){
      // build year list
      const years = new Set(state.trips.map(t=> (t.date||"").slice(0,4)).filter(Boolean));
      const thisYear = String(new Date().getFullYear());
      years.add(thisYear);

      const yearSel = $("d_year");
      if(yearSel){
        yearSel.innerHTML = "";
        Array.from(years).sort((a,b)=>b.localeCompare(a)).forEach(y=>{
          const opt = document.createElement("option");
          opt.value = y; opt.textContent = y;
          yearSel.appendChild(opt);
        });
        if(!yearSel.value) yearSel.value = thisYear;
      }

      const y = $("d_year")?.value || thisYear;
      const monthFilter = ($("d_month")?.value || "").trim(); // YYYY-MM

      const trips = state.trips.filter(t=>{
        const yd = (t.date||"");
        if(!yd.startsWith(y)) return false;
        if(monthFilter && !yd.startsWith(monthFilter)) return false;
        return true;
      });

      const revenue = trips.reduce((a,t)=>a+money(t.revenue),0);
      const expenses = trips.reduce((a,t)=>a+money(t.totals?.totalExpenses),0);
      const net = trips.reduce((a,t)=>a+money(t.totals?.net),0);
      const miles = trips.reduce((a,t)=>a+money(t.totalMiles),0);

      if($("d_rev")) $("d_rev").textContent = fmtMoney(revenue);
      if($("d_exp")) $("d_exp").textContent = fmtMoney(expenses);
      if($("d_net")) $("d_net").textContent = fmtMoney(net);
      if($("d_miles")) $("d_miles").textContent = fmtNum(miles);

      // goal compare (monthly goals vs chosen month if set, otherwise YTD heads-up)
      const goalBox = $("dashGoalBox");
      const goalOk = $("dashGoalOk");
      if(goalBox && goalOk){
        goalBox.classList.add("hide");
        goalOk.classList.add("hide");

        const bizGoal = money(state.goals.bizMonthly);
        const personGoal = money(state.goals.personalMonthly);

        if(monthFilter && (bizGoal>0 || personGoal>0)){
          const msgParts = [];
          const okParts = [];
          if(bizGoal>0){
            if(revenue < bizGoal) msgParts.push(`Business revenue is ${fmtMoney(bizGoal - revenue)} below goal (${fmtMoney(bizGoal)}).`);
            else okParts.push(`Business goal hit: ${fmtMoney(revenue)} / ${fmtMoney(bizGoal)} ‚úÖ`);
          }
          if(personGoal>0){
            // "personal goal" loosely equals net after trip expenses
            if(net < personGoal) msgParts.push(`Personal net is ${fmtMoney(personGoal - net)} below goal (${fmtMoney(personGoal)}).`);
            else okParts.push(`Personal goal hit: ${fmtMoney(net)} / ${fmtMoney(personGoal)} ‚úÖ`);
          }

          if(msgParts.length){
            goalBox.textContent = msgParts.join(" ");
            goalBox.classList.remove("hide");
          }
          if(okParts.length){
            goalOk.textContent = okParts.join(" ");
            goalOk.classList.remove("hide");
          }
        }
      }

      // insights
      const ins = $("insights");
      if(ins){
        ins.innerHTML = "";
        if(trips.length===0){
          const div = document.createElement("div");
          div.className="small";
          div.textContent = "No trips in this filter.";
          ins.appendChild(div);
        } else {
          const avgNet = net / Math.max(1,trips.length);
          const revPerMile = revenue / Math.max(1,miles);
          const netPerMile = net / Math.max(1,miles);

          const blocks = [
            `Trips: <b>${fmtNum(trips.length)}</b>`,
            `Avg net per trip: <b>${fmtMoney(avgNet)}</b>`,
            `Revenue per mile: <b>${fmtMoney(revPerMile)}</b>`,
            `Net per mile: <b>${fmtMoney(netPerMile)}</b>`
          ];

          blocks.forEach(html=>{
            const item = document.createElement("div");
            item.className="item";
            item.innerHTML = `<div class="itemTitle">${html}</div>`;
            ins.appendChild(item);
          });

          // Top lanes by net
          const lanes = {};
          trips.forEach(t=>{
            const key = `${t.pickup} ‚Üí ${t.delivery}`;
            lanes[key] = (lanes[key]||0) + money(t.totals?.net);
          });
          const best = Object.entries(lanes).sort((a,b)=>b[1]-a[1]).slice(0,3);
          if(best.length){
            const item = document.createElement("div");
            item.className="item";
            item.innerHTML = `<div class="itemTitle"><b>Top lanes (by net)</b></div>` +
              best.map(([k,v])=>`<div class="itemMeta">${escapeHtml(k)}: <span class="mono">${fmtMoney(v)}</span></div>`).join("");
            ins.appendChild(item);
          }
        }
      }
    }

    // ========= Settings =========
    function linesToList(txt){
      return (txt||"")
        .split("\n")
        .map(s=>s.trim())
        .filter(Boolean);
    }
    function listToLines(arr){
      return (arr||[]).filter(v=>v!=="Select‚Ä¶").join("\n");
    }

    function loadSettingsUI(){
      $("s_companies").value  = listToLines(state.lists.companies);
      $("s_shippers").value   = listToLines(state.lists.shippers);
      $("s_locations").value  = listToLines(state.lists.locations);
      $("s_tires").value      = listToLines(state.lists.tires);
      $("s_trucks").value     = listToLines(state.lists.trucks);
      $("s_trailers").value   = listToLines(state.lists.trailers);
      $("s_customers").value  = listToLines(state.lists.customers);
      $("s_consignees").value = listToLines(state.lists.consignees);
      $("s_budget_cats").value= (state.lists.budgetCats||[]).join("\n");

      $("r_tires").value = state.rates.tiresPerMile;
      $("r_maint").value = state.rates.maintPerMile;
      $("r_plates").value= state.rates.platesPerMile;
      $("r_ifta").value  = state.rates.iftaPerMile;
      $("r_tax_pct").value = state.rates.taxPctRevenue;
      $("r_mpg").value   = state.rates.targetMPG;
    }

    function saveLists(){
      const companies  = ensureSelect(linesToList($("s_companies").value));
      const shippers   = ensureSelect(linesToList($("s_shippers").value));
      const locations  = ensureSelect(linesToList($("s_locations").value));
      const tires      = ensureSelect(linesToList($("s_tires").value));
      const trucks     = ensureSelect(linesToList($("s_trucks").value));
      const trailers   = ensureSelect(linesToList($("s_trailers").value));
      const customers  = ensureSelect(linesToList($("s_customers").value));
      const consignees = ensureSelect(linesToList($("s_consignees").value));

      const budgetCats = linesToList($("s_budget_cats").value);

      state.lists.companies = companies.length?companies:structuredClone(defaults.lists.companies);
      state.lists.shippers  = shippers.length?shippers:structuredClone(defaults.lists.shippers);
      state.lists.locations = locations.length?locations:structuredClone(defaults.lists.locations);
      state.lists.tires     = tires.length?tires:structuredClone(defaults.lists.tires);
      state.lists.trucks    = trucks.length?trucks:structuredClone(defaults.lists.trucks);
      state.lists.trailers  = trailers.length?trailers:structuredClone(defaults.lists.trailers);
      state.lists.customers = customers.length?customers:structuredClone(defaults.lists.customers);
      state.lists.consignees= consignees.length?consignees:structuredClone(defaults.lists.consignees);
      state.lists.budgetCats= budgetCats.length?budgetCats:structuredClone(defaults.lists.budgetCats);

      saveState();
      loadTripDropdowns();
      loadBudgetUI();
      toast("Saved lists");
      refreshDashboard();
      loadInvoicesUI();
    }

    function resetLists(){
      state.lists = structuredClone(defaults.lists);
      saveState();
      loadSettingsUI();
      loadTripDropdowns();
      loadBudgetUI();
      toast("Reset defaults");
      loadInvoicesUI();
      refreshDashboard();
    }

    function saveRates(){
      state.rates.tiresPerMile = money(parseFloat($("r_tires")?.value));
      state.rates.maintPerMile = money(parseFloat($("r_maint")?.value));
      state.rates.platesPerMile= money(parseFloat($("r_plates")?.value));
      state.rates.iftaPerMile  = money(parseFloat($("r_ifta")?.value));
      state.rates.taxPctRevenue= money(parseFloat($("r_tax_pct")?.value));
      state.rates.targetMPG    = money(parseFloat($("r_mpg")?.value)) || defaults.rates.targetMPG;
      saveState();
      toast("Saved rates");
    }

    function nukeAll(){
      const ok = confirm("Delete ALL data? This cannot be undone.");
      if(!ok) return;
      localStorage.removeItem(LS_KEY);
      state = loadState();
      loadTripDropdowns();
      loadSettingsUI();
      loadBudgetUI();
      clearTripForm();
      renderTrips();
      loadInvoicesUI();
      refreshDashboard();
      toast("All data wiped");
    }

    // ========= Export / Import =========
    function exportData(){
      const blob = new Blob([JSON.stringify(state, null, 2)], {type:"application/json"});
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = "trucking-made-simple-backup.json";
      document.body.appendChild(a);
      a.click();
      a.remove();
      URL.revokeObjectURL(url);
      toast("Exported");
    }

    function importData(file){
      const reader = new FileReader();
      reader.onload = ()=>{
        try{
          const parsed = JSON.parse(String(reader.result||""));
          // merge into defaults safely
          state = {
            ...structuredClone(defaults),
            ...parsed,
            lists: { ...structuredClone(defaults.lists), ...(parsed.lists||{}) },
            rates: { ...structuredClone(defaults.rates), ...(parsed.rates||{}) },
            goals: { ...structuredClone(defaults.goals), ...(parsed.goals||{}) },
            trips: Array.isArray(parsed.trips) ? parsed.trips : [],
            budget: parsed.budget || {}
          };
          saveState();
          loadTripDropdowns();
          loadSettingsUI();
          loadBudgetUI();
          renderTrips();
          loadInvoicesUI();
          refreshDashboard();
          toast("Imported ‚úÖ");
        } catch(e){
          console.error(e);
          toast("Import failed");
        }
      };
      reader.readAsText(file);
    }

    // ========= Invoices =========
    function loadInvoicesUI(preselectTripId){
      const sel = $("inv_trip");
      if(!sel) return;
      sel.innerHTML = "";

      const opt0 = document.createElement("option");
      opt0.value = "";
      opt0.textContent = "Select a trip‚Ä¶";
      sel.appendChild(opt0);

      state.trips.slice(0,300).forEach(t=>{
        const opt = document.createElement("option");
        opt.value = t.id;
        const label = `${t.date} ¬∑ ${t.company} ¬∑ ${t.pickup} ‚Üí ${t.delivery}` + (t.ref ? ` ¬∑ ${t.ref}` : "");
        opt.textContent = label;
        sel.appendChild(opt);
      });

      if(preselectTripId){
        sel.value = preselectTripId;
      }
    }

    function nextInvoiceNumber(){
      // simple: INV-YYYYMMDD-XXXX where XXXX increments by count today
      const d = todayISO().replace(/-/g,"");
      const todays = state.trips.filter(t=> (t.date||"").replace(/-/g,"")===d).length;
      const seq = String(Math.max(1,todays)).padStart(4,"0");
      return `INV-${d}-${seq}`;
    }
    
function buildInvoiceHTML(trip, invDate, invNo){
  const safe = escapeHtml;

  const miles = money(trip.totalMiles);
  const loaded = money(trip.loadedMiles);
  const deadhead = money(trip.deadheadMiles);

  const revenue = money(trip.revenue);
  const fuelCost = money(trip.fuelCost);
  const tolls = money(trip.tolls);
  const other = money(trip.other);

  const r = trip.reserves || {};
  const resTires = money(r.tires);
  const resMaint = money(r.maint);
  const resPlates = money(r.plates);
  const resIFTA = money(r.ifta);
  const resTax = money(r.tax);

  const totalExpenses = money(trip.totals?.totalExpenses);
  const net = money(trip.totals?.net);
  const mpg = money(trip.totals?.mpg);

  const hasAddr = (s)=> (s && String(s).trim().length>0);
  const line = (label, value)=> `
    <div class="invMuted" style="margin:2px 0">
      ${safe(label)}: <b>${safe(value)}</b>
    </div>
  `;

  const smallMoneyLine = (label, value)=> `
    <div class="invLine"><span>${safe(label)}</span><span class="mono">${fmtMoney(value)}</span></div>
  `;

  return `
    <div class="invTop">
      <div>
        <div class="invH">INVOICE</div>
        <div class="invMuted">Invoice #: <b>${safe(invNo)}</b></div>
        <div class="invMuted">Invoice Date: <b>${safe(invDate)}</b></div>
        <div class="invMuted">Load Date: <b>${safe(trip.date || "")}</b></div>
      </div>

      <div style="text-align:right; min-width:260px">
        <div class="invMuted">Carrier / Company</div>
        <div style="font-size:14px;font-weight:800">${safe(trip.company || "")}</div>
        <div class="invMuted">Truck <b>${safe(trip.truck || "")}</b> ¬∑ Trailer <b>${safe(trip.trailer || "")}</b> ¬∑ Tire <b>${safe(trip.tireSize || "")}</b></div>
      </div>
    </div>

    <div class="invGrid2 invMetaGrid">
      <div class="invBlock">
        <div style="font-weight:900;margin-bottom:8px">Load Information</div>
        ${line("Shipper", trip.shipper || "")}
        ${line("Broker / Customer", trip.customer || "")}
        ${line("Consignee", trip.consignee || "")}
        ${trip.ref ? line("Load / Reference #", trip.ref) : ""}
        ${trip.notes ? line("Notes", trip.notes) : ""}
      </div>

      <div class="invBlock">
        <div style="font-weight:900;margin-bottom:8px">Route</div>
        ${line("Pickup (City/State)", trip.pickup || "")}
        ${hasAddr(trip.pickupAddr) ? `<div class="invMuted">${safe(trip.pickupAddr)}</div>` : `<div class="invMuted"> </div>`}

        <div style="height:8px"></div>

        ${line("Delivery (City/State)", trip.delivery || "")}
        ${hasAddr(trip.deliveryAddr) ? `<div class="invMuted">${safe(trip.deliveryAddr)}</div>` : `<div class="invMuted"> </div>`}
      </div>
    </div>

    <table class="invTable">
      <thead>
        <tr>
          <th>Description</th>
          <th class="invRight">Amount</th>
        </tr>
      </thead>
      <tbody>
        <tr>
          <td>
            <b>Freight Charge</b>
            <div class="invMuted">Pickup: ${safe(trip.pickup || "")} ‚Üí Delivery: ${safe(trip.delivery || "")}</div>
            ${trip.ref ? `<div class="invMuted">Ref: ${safe(trip.ref)}</div>` : ""}
          </td>
          <td class="invRight mono"><b>${fmtMoney(revenue)}</b></td>
        </tr>
      </tbody>
    </table>

    <div class="invGrid2">
      <div class="invBlock">
        <div style="font-weight:900;margin-bottom:8px">Trip Stats</div>
        <div class="invMuted">Loaded miles: <b class="mono">${fmtNum(loaded)}</b></div>
        <div class="invMuted">Deadhead miles: <b class="mono">${fmtNum(deadhead)}</b></div>
        <div class="invMuted">Total miles: <b class="mono">${fmtNum(miles)}</b></div>
        <div class="invMuted">Fuel gallons: <b class="mono">${fmtNum(money(trip.fuelGallons))}</b></div>
        <div class="invMuted">Avg fuel cost/gal: <b class="mono">${fmtMoney(money(trip.fuelCostPerGallon))}</b></div>
        <div class="invMuted">MPG (est): <b class="mono">${mpg.toFixed(2)}</b></div>
      </div>

      <div class="invBlock">
        <div style="font-weight:900;margin-bottom:8px">Costs + Reserves (for your records)</div>
        <div class="invMuted">Fuel cost: <b class="mono">${fmtMoney(fuelCost)}</b></div>
        <div class="invMuted">Tolls: <b class="mono">${fmtMoney(tolls)}</b></div>
        <div class="invMuted">Other trip expenses: <b class="mono">${fmtMoney(other)}</b></div>

        <div class="invMuted" style="margin-top:8px; font-weight:800">Reserves</div>
        <div class="invMuted">Tires: <b class="mono">${fmtMoney(resTires)}</b></div>
        <div class="invMuted">Maintenance: <b class="mono">${fmtMoney(resMaint)}</b></div>
        <div class="invMuted">Plates: <b class="mono">${fmtMoney(resPlates)}</b></div>
        <div class="invMuted">IFTA (est): <b class="mono">${fmtMoney(resIFTA)}</b></div>
        <div class="invMuted">Tax (est): <b class="mono">${fmtMoney(resTax)}</b></div>
      </div>
    </div>

    <div class="invTotal">
      <div class="invTotalBox">
        ${smallMoneyLine("Freight charge", revenue)}
        ${smallMoneyLine("Fuel + tolls + other (record)", fuelCost + tolls + other)}
        ${smallMoneyLine("Reserves (record)", resTires + resMaint + resPlates + resIFTA + resTax)}
        <div class="invLine"><span class="invMuted">Total expenses (record)</span><span class="mono">${fmtMoney(totalExpenses)}</span></div>
        <div class="invLine invBig"><span>Total Due</span><span class="mono">${fmtMoney(revenue)}</span></div>
        <div class="invLine"><span class="invMuted">Trip Net (record)</span><span class="mono">${fmtMoney(net)}</span></div>
      </div>
    </div>

    <div class="invBlock invSigRow" style="margin-top:12px">
      <div style="font-weight:900;margin-bottom:6px">Payment / Notes</div>
      <div class="invMuted">Add your remittance address, payment terms, factoring info, etc. here (optional).</div>
      <div class="invMuted" style="margin-top:10px">Carrier Signature: ____________________________</div>
    </div>

    <div class="invMuted" style="margin-top:12px">
      Thank you for your business.
    </div>
  `;
}
    function buildInvoicePreview(){
      const id = $("inv_trip")?.value;
      if(!id){ toast("Select a trip"); return; }

      const trip = state.trips.find(t=>t.id===id);
      if(!trip){ toast("Trip not found"); return; }

      const invDate = ($("inv_date")?.value || trip.date || todayISO());
      const invNo = (($("inv_number")?.value||"").trim() || nextInvoiceNumber());

      const preview = $("invoicePreview");
      if(preview){
        preview.innerHTML = buildInvoiceHTML(trip, invDate, invNo);
      }
      toast("Invoice built");
    }

function printInvoice(){
  // Ensure invoice preview exists and invoice tab isn't hidden
  const invoicesTab = document.querySelector('.tab[data-tab="invoices"]');
  const invoicesSection = $("tab-invoices");

  // Build preview if empty/placeholder
  const preview = $("invoicePreview");
  const isPlaceholder = preview && (preview.textContent || "").includes("No invoice selected");
  if(isPlaceholder) buildInvoicePreview();

  // Force invoices section visible for print (even if user is on another tab)
  const wasHidden = invoicesSection?.classList.contains("hide");
  if(invoicesSection) invoicesSection.classList.remove("hide");

  // Also mark the tab active visually (doesn't matter for print, but keeps UI consistent)
  document.querySelectorAll(".tab").forEach(t=>t.classList.remove("active"));
  invoicesTab?.classList.add("active");

  // Hide other sections in-app (optional but clean)
  ["trips","budget","dashboard","settings"].forEach(n=>{
    const sec = $("tab-"+n);
    if(sec) sec.classList.add("hide");
  });

  // Print
  window.print();

  // After print, restore previous hidden state
  window.addEventListener("afterprint", ()=>{
    if(invoicesSection && wasHidden) invoicesSection.classList.add("hide");
    // Note: we don't try to restore which tab you were on because it gets messy.
    // If you want that, I can add a tiny "remember current tab" variable.
  }, { once:true });
}

    // ========= Wire up events =========
    on("btn_calc","click", ()=> calcTrip());
    on("btn_save","click", ()=> saveTrip());
    on("btn_clear","click", ()=> { clearTripForm(); toast("Cleared"); });

    on("searchTrips","input", ()=> renderTrips());

    on("btn_export","click", ()=> exportData());
    on("btn_import","click", ()=> $("importFile")?.click());
    on("importFile","change", (e)=>{
      const f = e.target.files && e.target.files[0];
      if(f) importData(f);
      e.target.value = "";
    });

    on("btn_add_exp","click", ()=> addExpense());
    on("btn_budget_calc","click", ()=> { calcBudget(); toast("Calculated"); });
    on("btn_budget_clear","click", ()=> clearBudgetMonth());
    on("b_month","change", ()=> renderBudget());
    on("b_buffer","input", ()=> calcBudget());
    on("b_withhold","input", ()=> calcBudget());
    on
("b_withhold","input", ()=> calcBudget());
    on("b_other_income","input", ()=> calcBudget());
    on("b_paychecks","change", ()=> calcBudget());

    on("btn_save_goals","click", ()=> saveGoals());

    on("btn_dash","click", ()=> refreshDashboard());
    on("d_year","change", ()=> refreshDashboard());
    on("d_month","change", ()=> refreshDashboard());

    on("btn_save_lists","click", ()=> saveLists());
    on("btn_reset_lists","click", ()=> resetLists());

    on("btn_save_rates","click", ()=> saveRates());

    on("btn_save_budget_cats","click", ()=> saveLists());

    on("btn_nuke","click", ()=> nukeAll());

    on("btn_inv_preview","click", ()=> buildInvoicePreview());
    on("btn_inv_print","click", ()=> printInvoice());

    on("inv_trip","change", ()=>{
      // optional: auto-build preview on selection (comment out if you hate convenience)
      // buildInvoicePreview();
    });

    // ========= Init =========
    loadTripDropdowns();
    loadSettingsUI();
    loadBudgetUI();

    // default date
    if($("t_date")) $("t_date").value = todayISO();

    // first paint
    updateTripKPIs(readTripForm());
    renderTrips();
    loadInvoicesUI();
    refreshDashboard();

    setStatus("‚úÖ Ready");
  } catch(err){
    console.error(err);
    setStatus("‚ùå Error (open Console)");
  }
});
</script>
</body>
</html>
